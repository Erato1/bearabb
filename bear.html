```html
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>ğŸ» ç†Šå…”æ—¥å¸¸ Â· å·²è¯»ä¿®å¤+å–«èŒ¶åˆ¸ä¼˜åŒ–ç‰ˆ ğŸ‡</title>
    <style>
        /* æ‰€æœ‰æ ·å¼ä¿æŒä¸å˜ï¼Œåªä¿®æ”¹äº†å–«èŒ¶åˆ¸çº¸å¼ æ¡†å¤§å° */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease, color 0.2s ease, border-color 0.3s ease;
        }
        body {
            background: #fff0f5;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overscroll-behavior: none;
        }
        :root {
            --bg-primary: #fff0f5;
            --bg-secondary: white;
            --bg-tertiary: #fff5fa;
            --border-color: #ffd9e6;
            --text-primary: #b14b6f;
            --text-secondary: #8f5a70;
            --message-me: #ffe2ed;
            --message-other: white;
            --button-shadow: #f58bab;
            --button-border: #ff99bb;
            --pat-bg: #e6d5ff;
            --anniversary-bg: #fff2cc;
            --tarot-bg: #f0e6ff;
            --memo-reply-bg: #e0f0ff;
            --book-bg: #d9e6f2;
            --coupon-bg: #f2e6d9;
            --font-size-base: 16px;
            --bubble-radius: 20px;
            --love-days-size: 16px;
        }
        body.dark-mode {
            --bg-primary: #2a1e24;
            --bg-secondary: #3a2c33;
            --bg-tertiary: #4a3a42;
            --border-color: #6b4f5a;
            --text-primary: #ffb8cf;
            --text-secondary: #d9a6b8;
            --message-me: #8b5a7a;
            --message-other: #4a3a42;
            --button-shadow: #6b4f5a;
            --button-border: #b28dd9;
            --pat-bg: #5a4a6a;
            --anniversary-bg: #4a4a3a;
            --tarot-bg: #4a3a5a;
            --memo-reply-bg: #2a4a5a;
            --book-bg: #2a4a4a;
            --coupon-bg: #4a4a2a;
            background: var(--bg-primary);
        }
        .chat-main {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            flex-shrink: 0;
        }
        .avatar-left, .avatar-right {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-width: 60px;
        }
        .avatar-img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #ffd9e6;
            border: 3px solid var(--bg-secondary);
            box-shadow: 0 3px 8px rgba(255, 140, 170, 0.3);
            object-fit: cover;
            cursor: pointer;
        }
        .avatar-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
        }
        .avatar-status {
            font-size: 9px;
            color: var(--text-secondary);
            background: var(--message-me);
            padding: 2px 6px;
            border-radius: 30px;
            max-width: 65px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        .center-icons {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
            flex: 1;
        }
        .icon-btn {
            background: var(--bg-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 3px 0 var(--button-shadow);
            border: 2px solid var(--button-border);
            cursor: pointer;
            color: var(--text-primary);
            flex-shrink: 0;
        }
        .theme-toggle {
            background: var(--bg-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 3px 0 var(--button-shadow);
            border: 2px solid var(--button-border);
            cursor: pointer;
            margin-left: 2px;
            flex-shrink: 0;
        }
        .daily-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-primary);
        }
        .love-days {
            font-size: var(--love-days-size);
            font-weight: bold;
        }
        .session-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            white-space: nowrap;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            -webkit-overflow-scrolling: touch;
        }
        .session-tab {
            background: var(--bg-secondary);
            border: 2px solid var(--button-border);
            border-radius: 40px;
            padding: 6px 14px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: var(--text-primary);
            flex-shrink: 0;
        }
        .session-tab.active {
            background: var(--message-me);
            border-color: var(--text-primary);
        }
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--bg-tertiary);
            -webkit-overflow-scrolling: touch;
            font-size: var(--font-size-base);
        }
        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: var(--bubble-radius);
            word-wrap: break-word;
            font-size: var(--font-size-base);
            position: relative;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .message.me {
            background: var(--message-me);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .message.other {
            background: var(--message-other);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            cursor: pointer;
        }
        .message.other.long-press {
            background: var(--tarot-bg);
            transform: scale(1.02);
        }
        .message.pat {
            background: var(--pat-bg);
            align-self: center;
            font-style: italic;
            border-radius: 30px;
            max-width: 70%;
            text-align: center;
            border: 2px dashed var(--button-border);
        }
        .message.image-message {
            padding: 5px;
            background: transparent;
            max-width: 70%;
        }
        .message.image-message img {
            max-width: 100%;
            border-radius: 15px;
            border: 3px solid var(--bg-secondary);
        }
        .message.memo-reply, .message.book-reply, .message.coupon-reply {
            background: var(--memo-reply-bg);
            align-self: flex-start;
            margin-left: 20px;
            max-width: 70%;
            border-left: 4px solid var(--border-color);
        }
        .message.book-review {
            background: var(--book-bg);
            align-self: flex-start;
            max-width: 80%;
        }
        .message.coupon {
            background: var(--coupon-bg);
            align-self: center;
            max-width: 90%;
            width: 90%;
            border: 2px dashed var(--border-color);
            text-align: center;
            padding: 20px;
        }
        .read-receipt {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
            text-align: right;
            align-self: flex-end;
        }
        .typing-indicator {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 5px 10px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            align-self: flex-start;
            animation: blink 1.5s infinite;
        }
        @keyframes blink {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        .input-area {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border-top: 2px solid var(--border-color);
            flex-shrink: 0;
        }
        .input-left {
            display: flex;
            gap: 5px;
        }
        .input-icon {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--button-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 0 var(--button-shadow);
            color: var(--text-primary);
            flex-shrink: 0;
        }
        .custom-emoji-icon {
            background: var(--bg-secondary);
            border: 2px solid var(--button-border);
            border-radius: 50%;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-primary);
        }
        .input-field {
            flex: 1;
            background: var(--bg-tertiary);
            border: 2px solid var(--button-border);
            border-radius: 30px;
            padding: 10px 15px;
            font-size: 15px;
            outline: none;
            color: var(--text-primary);
            min-width: 0;
        }
        .input-field::placeholder {
            color: var(--text-secondary);
        }
        .input-right {
            display: flex;
            gap: 5px;
        }
        .send-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--button-border);
            border-radius: 50px;
            padding: 0 16px;
            height: 42px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            box-shadow: 0 3px 0 var(--button-shadow);
            cursor: pointer;
            flex-shrink: 0;
        }
        .more-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--button-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 3px 0 var(--button-shadow);
            color: var(--text-primary);
            flex-shrink: 0;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            z-index: 2000;
            visibility: hidden;
        }
        .modal.show { visibility: visible; }
        .modal-content {
            background: var(--bg-secondary);
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            border-radius: 25px 25px 0 0;
            padding: 20px 15px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            color: var(--text-primary);
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .modal.show .modal-content { transform: translateY(0); }
        .drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 90%;
            max-width: 400px;
            height: 100vh;
            background: var(--bg-secondary);
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px 15px;
            border-radius: 25px 0 0 25px;
            color: var(--text-primary);
            -webkit-overflow-scrolling: touch;
        }
        .drawer.open { right: 0; }
        .hidden { display: none; }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            display: none;
            z-index: 999;
        }
        .overlay.show { display: block; }
        .file-input-hidden { display: none; }
        .flex-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .card { background: var(--bg-tertiary); border-radius: 20px; padding: 15px; margin: 10px 0; }
        .badge { background: var(--message-me); border-radius: 30px; padding: 4px 12px; font-size: 13px; display: inline-block; }
        .memo-item { border-bottom: 1px dashed var(--border-color); padding: 8px 0; font-size: 14px; }
        .toggle-btn { min-width: 60px; }
        .bulk-message-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-tertiary); padding: 8px 12px; border-radius: 30px; margin: 5px 0; }
        .music-embed iframe { width: 100%; height: 80px; border-radius: 15px; }
        .custom-emoji-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px 0; }
        .custom-emoji-item { text-align: center; position: relative; background: var(--bg-tertiary); border-radius: 15px; padding: 10px; }
        .custom-emoji-item img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 10px; }
        .custom-emoji-item button { position: absolute; top: -5px; right: -5px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; }
        .music-item { display: flex; align-items: center; gap: 5px; margin: 5px 0; padding: 5px; background: var(--message-me); border-radius: 30px; }
        .music-item input { flex: 1; background: var(--bg-secondary); border: 1px solid var(--button-border); border-radius: 20px; padding: 5px 10px; color: var(--text-primary); }
        .anniversary-item { background: var(--anniversary-bg); border-radius: 15px; padding: 10px; margin: 5px 0; }
        .tarot-card { background: var(--tarot-bg); border-radius: 20px; padding: 15px; margin: 10px 0; text-align: center; border: 3px solid var(--border-color); }
        .tarot-name { font-size: 20px; font-weight: bold; color: var(--text-primary); margin-bottom: 8px; }
        .tarot-meaning { font-size: 14px; color: var(--text-secondary); line-height: 1.4; }
        .decision-input { width: 100%; padding: 8px; border-radius: 15px; border: 2px solid var(--button-border); background: var(--bg-secondary); color: var(--text-primary); margin-bottom: 10px; }
        .session-manager { background: var(--bg-tertiary); border-radius: 20px; padding: 15px; margin: 10px 0; }
        .group-member { display: flex; gap: 10px; align-items: center; margin: 8px 0; padding: 8px; background: var(--bg-secondary); border-radius: 15px; }
        .card-category { background: var(--bg-tertiary); border-radius: 15px; padding: 10px; margin: 5px 0; }
        .card-category-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .book-item, .todo-item, .coupon-item { background: var(--bg-tertiary); border-radius: 15px; padding: 8px; margin: 5px 0; display: flex; justify-content: space-between; }
        .percentage-bar { width: 100%; height: 20px; background: var(--bg-tertiary); border-radius: 10px; margin: 5px 0; overflow: hidden; }
        .percentage-fill { height: 100%; background: var(--message-me); transition: width 0.3s; }
        .stats-list { font-size: 14px; line-height: 1.8; }
        .quote-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); padding: 20px; border-radius: 20px; z-index: 3000; display: none; }
    </style>
</head>
<body>
    <div class="chat-main">
        <div class="top-bar">
            <!-- å·¦ä¾§ï¼šå¯¹æ–¹ï¼ˆå°ç†Šï¼‰ -->
            <div class="avatar-left">
                <img src="" alt="other" class="avatar-img" id="otherAvatarImg" onclick="document.getElementById('otherAvatarUpload').click()">
                <span class="avatar-name" id="otherName">å°ç†Š</span>
                <span class="avatar-status" id="otherStatus">åœ¨çº¿</span>
                <input type="file" id="otherAvatarUpload" class="file-input-hidden" accept="image/*" onchange="uploadAvatar(event, 'other')">
            </div>
            
            <div class="center-icons">
                <div class="icon-btn" onclick="openDrawer('appearance')">ğŸ¨</div>
                <div class="icon-btn" onclick="openDrawer('chat')">ğŸ’¬</div>
                <div class="icon-btn" onclick="openDrawer('data')">ğŸ’¾</div>
                <div class="icon-btn" onclick="openDrawer('daily')">ğŸ“</div>
                <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()">â˜€ï¸</div>
            </div>
            
            <!-- å³ä¾§ï¼šè‡ªå·±ï¼ˆå°å…”ï¼‰ -->
            <div class="avatar-right">
                <img src="" alt="me" class="avatar-img" id="meAvatarImg" onclick="document.getElementById('meAvatarUpload').click()">
                <span class="avatar-name" id="meName">å°å…”</span>
                <span class="avatar-status" id="meStatus">åœ¨çº¿</span>
                <input type="file" id="meAvatarUpload" class="file-input-hidden" accept="image/*" onchange="uploadAvatar(event, 'me')">
            </div>
        </div>

        <!-- æ—¥å¸¸ç»Ÿè®¡ä¿¡æ¯æ  -->
        <div class="daily-stats">
            <span class="love-days" id="loveDaysDisplay">å’Œå°ç†Šæ‹çˆ±çš„ç¬¬ 1 å¤©</span>
            <span>æ€»æ¶ˆæ¯: <span id="totalMsgCount">0</span> | æˆ‘: <span id="myMsgCount">0</span></span>
        </div>

        <!-- ä¼šè¯æ  (åŠ¨æ€ç®¡ç†) -->
        <div class="session-scroll" id="sessionBar">
            <div class="session-tab active" data-session="default" onclick="switchSession('default')">ğŸ’¬ ä»Šæ—¥é—²èŠ</div>
        </div>

        <!-- æ¶ˆæ¯åŒºåŸŸ (èŠå¤©è®°å½•ä¼šè‡ªåŠ¨ä¿å­˜) -->
        <div class="messages-area" id="chatMessages"></div>

        <!-- åº•éƒ¨è¾“å…¥åŒº -->
        <div class="input-area">
            <div class="input-left">
                <div class="input-icon" onclick="openImageModal()">ğŸ“·</div>
                <div class="input-icon" onclick="openPatModal()">âœ‹</div>
                <div class="custom-emoji-icon" onclick="openCustomEmojiModal()">ğŸ˜Š</div>
            </div>
            <input type="text" class="input-field" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">
            <div class="input-right">
                <button class="send-btn" id="sendChatBtn" onclick="sendMessage()">å‘é€</button>
                <div class="more-btn" onclick="openBulkModal()">â‹¯</div>
                <div class="more-btn" onclick="triggerHeWantsToSay()">ğŸ’¬</div>
            </div>
        </div>
    </div>

    <!-- é•¿æŒ‰å¼•ç”¨/æ”¶è—æ¨¡æ€æ¡† -->
    <div class="quote-modal" id="quoteModal">
        <h4>é€‰æ‹©æ“ä½œ</h4>
        <button class="send-btn" onclick="quoteMessage()">å¼•ç”¨å¹¶å›å¤</button>
        <button class="send-btn" onclick="favoriteMessage()">æ”¶è—è¿™å¥è¯</button>
        <button class="send-btn" onclick="closeQuoteModal()">å–æ¶ˆ</button>
    </div>

    <!-- è‡ªå®šä¹‰è¡¨æƒ…åŒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="customEmojiModal" onclick="if(event.target===this) closeCustomEmojiModal()">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; justify-content:space-between; margin-bottom:15px">
                <h3>ğŸ˜Š è‡ªå®šä¹‰è¡¨æƒ…åŒ…</h3>
                <span style="font-size:28px; cursor:pointer" onclick="closeCustomEmojiModal()">âœ•</span>
            </div>
            <div style="margin-bottom:15px">
                <input type="file" id="customEmojiFile" accept="image/*" onchange="previewCustomEmoji(event)">
                <button class="send-btn" style="margin-top:10px" onclick="addCustomEmoji()">ä¿å­˜åˆ°è¡¨æƒ…åŒ…</button>
            </div>
            <div class="custom-emoji-grid" id="customEmojiGrid"></div>
        </div>
    </div>

    <!-- æ‰¹é‡å‘é€æ¨¡æ€æ¡† -->
    <div class="modal" id="bulkModal" onclick="if(event.target===this) closeBulkModal()">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; justify-content:space-between; margin-bottom:15px">
                <h3>ğŸ“¤ æ‰¹é‡å‘é€</h3>
                <span style="font-size:28px; cursor:pointer" onclick="closeBulkModal()">âœ•</span>
            </div>
            <textarea id="bulkInput" rows="4" placeholder="è¾“å…¥å¤šæ¡æ¶ˆæ¯ï¼Œæ¯æ¡ç”¨æ¢è¡Œåˆ†éš”" style="width:100%; padding:12px; border-radius:15px; border:2px solid var(--button-border); background:var(--bg-tertiary); color:var(--text-primary); margin-bottom:10px"></textarea>
            <button class="send-btn" style="width:100%; margin-bottom:15px" onclick="prepareBulkMessages()">ç”Ÿæˆåˆ—è¡¨</button>
            <div id="bulkMessageList" style="max-height:300px; overflow-y:auto; margin:15px 0"></div>
            <div style="display:flex; gap:10px; margin-top:15px">
                <button class="send-btn" style="flex:1" onclick="sendAllBulkMessages()">å…¨éƒ¨å‘é€</button>
                <button class="send-btn" style="flex:1" onclick="closeBulkModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡å‘é€æ¨¡æ€æ¡† (ç§»é™¤è¡¨æƒ…åŒ…é€‰é¡¹) -->
    <div class="modal" id="imageModal" onclick="if(event.target===this) closeImageModal()">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; justify-content:space-between; margin-bottom:15px">
                <h3>ğŸ“· å‘é€å›¾ç‰‡</h3>
                <span style="font-size:28px; cursor:pointer" onclick="closeImageModal()">âœ•</span>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <button class="send-btn" style="flex:1" onclick="showImageTab('upload')">ä¸Šä¼ æ–‡ä»¶</button>
                <button class="send-btn" style="flex:1" onclick="showImageTab('url')">URLå¯¼å…¥</button>
            </div>
            
            <div id="imageUploadTab">
                <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)">
                <div id="imagePreview" style="margin:10px 0; text-align:center"></div>
            </div>
            
            <div id="imageUrlTab" style="display:none">
                <input type="text" id="imageUrl" placeholder="ç²˜è´´å›¾ç‰‡URL" style="width:100%; padding:12px; border-radius:15px; border:2px solid var(--button-border); background:var(--bg-tertiary); color:var(--text-primary)">
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px">
                <button class="send-btn" style="flex:1" onclick="sendImage()">å‘é€</button>
                <button class="send-btn" style="flex:1" onclick="closeImageModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ‹ä¸€æ‹æ¨¡æ€æ¡† -->
    <div class="modal" id="patModal" onclick="if(event.target===this) closePatModal()">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; justify-content:space-between; margin-bottom:15px">
                <h3>âœ‹ æ‹ä¸€æ‹</h3>
                <span style="font-size:28px; cursor:pointer" onclick="closePatModal()">âœ•</span>
            </div>
            <input type="text" id="patInput" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..." style="width:100%; padding:12px; border-radius:15px; border:2px solid var(--button-border); background:var(--bg-tertiary); color:var(--text-primary); margin-bottom:15px">
            <div style="display:flex; gap:10px">
                <button class="send-btn" style="flex:1" onclick="sendPat()">å‘é€æ‹ä¸€æ‹</button>
                <button class="send-btn" style="flex:1" onclick="closePatModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ä¾§è¾¹æ æŠ½å±‰ (å®Œæ•´ç‰ˆæ‰€æœ‰åŠŸèƒ½) -->
    <div class="overlay" id="overlay" onclick="closeDrawer()"></div>
    <div class="drawer" id="drawer">
        <div class="drawer-header" style="display:flex; justify-content:space-between; margin-bottom:20px">
            <h2 id="drawerTitle">âš™ï¸ è®¾ç½®</h2>
            <span style="font-size:28px; cursor:pointer" onclick="closeDrawer()">âœ•</span>
        </div>

        <!-- å¤–è§‚è®¾ç½® -->
        <div id="appearanceSection" class="drawer-section">
            <h3>ğŸ¨ å¤–è§‚è®¾ç½®</h3>
            
            <h4>èƒŒæ™¯è®¾ç½®</h4>
            <label>èƒŒæ™¯é¢œè‰²</label>
            <input type="color" id="bgColor" value="#fff0f5" onchange="changeBgColor(this.value)" style="width:100%; height:50px;">
            <button class="send-btn" style="width:100%; margin:10px 0" onclick="uploadBackgroundImage()">ğŸ“¤ ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡</button>
            
            <h4>èŠå¤©æ°”æ³¡å½¢çŠ¶</h4>
            <select id="bubbleShapeSelect" onchange="changeBubbleShape(this.value)" style="width:100%; padding:10px; margin-bottom:10px;">
                <option value="20px">æ ‡å‡† (20px)</option>
                <option value="30px">åœ†è§’ (30px)</option>
                <option value="40px">å¤§åœ†è§’ (40px)</option>
                <option value="5px">æ–¹å½¢ (5px)</option>
            </select>
            
            <h4>æ°”æ³¡è‡ªå®šä¹‰CSS</h4>
            <textarea id="bubbleCustomCSS" rows="3" placeholder="è¾“å…¥è‡ªå®šä¹‰CSSä»£ç " style="width:100%; padding:8px; border-radius:10px; margin-bottom:10px;"></textarea>
            <button class="send-btn" style="width:100%; margin-bottom:10px;" onclick="applyBubbleCustomCSS()">åº”ç”¨è‡ªå®šä¹‰æ°”æ³¡</button>
            
            <h4>å­—ä½“è®¾ç½®</h4>
            <label>å­—ä½“é“¾æ¥ (CSS/TTF)</label>
            <input type="text" id="fontLink" placeholder="https://..." style="width:100%; padding:8px; margin:5px 0;" onchange="applyFontLink(this.value)">
            <label>å­—ä½“å¤§å° (12px ~ 24px)</label>
            <input type="range" id="fontSizeSlider" min="12" max="24" value="16" onchange="adjustFontSize(this.value)" style="width:100%">
            <span id="fontSizeDisplay">16px</span>
            
            <h4>æ‹çˆ±å¤©æ•°å­—ä½“å¤§å°</h4>
            <input type="range" id="loveDaysSizeSlider" min="12" max="24" value="16" onchange="adjustLoveDaysSize(this.value)" style="width:100%">
            
            <h4>å¤´åƒè®¾ç½®</h4>
            <div style="margin:10px 0">
                <label>å¤´åƒå¼€å…³</label>
                <button class="send-btn toggle-btn" id="avatarToggleBtn" onclick="toggleAvatarVisibility()">å¼€å¯</button>
            </div>
            <label>å¤´åƒå°ºå¯¸ (24px ~ 48px)</label>
            <input type="range" id="avatarSizeSlider" min="24" max="48" value="40" onchange="adjustAvatarSize(this.value)" style="width:100%">
            
            <label>æˆ‘çš„åå­—</label>
            <input type="text" id="meNameInput" value="å°å…”" onchange="updateNames()" style="width:100%; padding:8px; margin:5px 0;">
            <label>å¯¹æ–¹åå­—</label>
            <input type="text" id="otherNameInput" value="å°ç†Š" onchange="updateNames()" style="width:100%; padding:8px; margin:5px 0;">
            <label>æ°”æ³¡é¢œè‰²(æˆ‘çš„)</label>
            <input type="color" id="bubbleColor" value="#ffe2ed" onchange="changeBubbleColor(this.value)" style="width:100%; height:50px;">
            
            <button class="send-btn" style="width:100%; margin-top:15px" onclick="saveAppearanceSettings()">ä¿å­˜å¤–è§‚è®¾ç½®</button>
        </div>

        <!-- èŠå¤©è®¾ç½® -->
        <div id="chatSection" class="drawer-section hidden">
            <h3>ğŸ’¬ èŠå¤©è®¾ç½®</h3>
            
            <h4>ä¼šè¯ç®¡ç†</h4>
            <div class="session-manager">
                <div class="flex-row">
                    <input type="text" id="newSessionName" placeholder="æ–°ä¼šè¯åç§°" style="flex:1; padding:8px;">
                    <button class="send-btn" onclick="createNewSession()">æ–°å»º</button>
                </div>
                <div id="sessionList" style="margin-top:10px;"></div>
            </div>
            
            <h4>ç¾¤èŠç®¡ç†</h4>
            <div class="session-manager">
                <div class="flex-row">
                    <input type="text" id="newGroupName" placeholder="ç¾¤èŠåç§°" style="flex:1; padding:8px;">
                    <button class="send-btn" onclick="createGroupChat()">åˆ›å»º</button>
                </div>
                <div id="groupList" style="margin-top:10px;"></div>
            </div>
            
            <h4>åŸºæœ¬è®¾ç½®</h4>
            <div class="flex-row"><label>å¼•ç”¨æ¶ˆæ¯</label><button class="send-btn toggle-btn" id="quoteToggle" onclick="toggleSetting('quote')">å…³é—­</button></div>
            <div class="flex-row"><label>æ¶ˆæ¯éŸ³æ•ˆ</label><button class="send-btn toggle-btn" id="soundToggle" onclick="toggleSetting('sound')">å…³é—­</button></div>
            <div class="flex-row"><label>å·²è¯»å›æ‰§</label><button class="send-btn toggle-btn" id="readToggle" onclick="toggleSetting('readReceipt')">å¼€å¯</button></div>
            <div class="flex-row"><label>æ­£åœ¨è¾“å…¥</label><button class="send-btn toggle-btn" id="typingToggle" onclick="toggleSetting('typing')">å…³é—­</button></div>
            
            <label>å¯¹æ–¹å›å¤é€Ÿåº¦ æœ€å°é—´éš” (0.1s~120s)</label>
            <input type="number" id="minReplyDelay" min="0.1" max="120" step="0.1" value="0.5" style="width:100%; margin:5px 0;">
            <label>æœ€å¤§é—´éš”</label>
            <input type="number" id="maxReplyDelay" min="0.1" max="120" step="0.1" value="2.0" style="width:100%; margin:5px 0;">
            
            <h4>ä»Šæ—¥é—²èŠå›å¤æ¡æ•°</h4>
            <select id="chatReplyCount" onchange="updateChatReplyCount(this.value)" style="width:100%; padding:8px; margin:5px 0;">
                <option value="1-3">1-3æ¡</option>
                <option value="1-4">1-4æ¡</option>
                <option value="1-5">1-5æ¡</option>
                <option value="1-6">1-6æ¡</option>
                <option value="1-7">1-7æ¡</option>
                <option value="1-8">1-8æ¡</option>
                <option value="1-9">1-9æ¡</option>
                <option value="1-10">1-10æ¡</option>
            </select>
            
            <h4>â‹¯é”®å›å¤æ¡æ•°</h4>
            <select id="bulkReplyCount" onchange="updateBulkReplyCount(this.value)" style="width:100%; padding:8px; margin:5px 0;">
                <option value="1-3">1-3æ¡</option>
                <option value="1-4">1-4æ¡</option>
                <option value="1-5">1-5æ¡</option>
                <option value="1-6">1-6æ¡</option>
                <option value="1-7">1-7æ¡</option>
                <option value="1-8">1-8æ¡</option>
                <option value="1-9">1-9æ¡</option>
                <option value="1-10">1-10æ¡</option>
            </select>
            
            <h4>æ”¶è—çš„å›å¤</h4>
            <div id="favoritesList" style="max-height:150px; overflow-y:auto; background:var(--bg-tertiary); border-radius:15px; padding:10px; margin:5px 0;"></div>
            
            <h4>æ‹ä¸€æ‹å¯¹æ–¹å›å¤åº“</h4>
            <div class="flex-row">
                <input type="text" id="newPatReply" placeholder="æ–°å¢æ‹ä¸€æ‹å›å¤" style="flex:1; padding:8px;">
                <button class="send-btn" onclick="addPatReply()">æ·»åŠ </button>
            </div>
            <div id="patReplyList" style="max-height:150px; overflow-y:auto; background:var(--bg-tertiary); border-radius:15px; padding:10px; margin:5px 0;"></div>
            
            <h4>å¯¹æ–¹çŠ¶æ€åº“</h4>
            <div class="flex-row">
                <input type="text" id="newStatus" placeholder="æ–°å¢çŠ¶æ€" style="flex:1; padding:8px;">
                <button class="send-btn" onclick="addStatus()">æ·»åŠ </button>
            </div>
            <div id="statusList" style="max-height:150px; overflow-y:auto; background:var(--bg-tertiary); border-radius:15px; padding:10px; margin:5px 0;"></div>
            
            <h4>æ‹çˆ±å¤©æ•°è®¾ç½®</h4>
            <label>èµ·å§‹æ—¥æœŸ</label>
            <input type="date" id="loveStartDate" onchange="updateLoveDays()" style="width:100%; padding:8px; margin:5px 0;">
            
            <button class="send-btn" style="width:100%; margin-top:15px" onclick="saveChatSettings()">ä¿å­˜èŠå¤©è®¾ç½®</button>
        </div>

        <!-- æ•°æ®ç®¡ç† -->
        <div id="dataSection" class="drawer-section hidden">
            <h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3>
            <button class="send-btn" style="width:100%; margin-bottom:10px" onclick="exportAllData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
            <button class="send-btn" style="width:100%; margin-bottom:10px" onclick="importAllData()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
            <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImportFile(event)">
            <button class="send-btn" style="width:100%; margin-bottom:10px" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            <button class="send-btn" style="width:100%;" onclick="resetToDefault()">æ¢å¤é»˜è®¤</button>
        </div>

        <!-- æ—¥å¸¸äº’åŠ¨ -->
        <div id="dailySection" class="drawer-section hidden">
            <h3>ğŸ“ æ—¥å¸¸äº’åŠ¨å¤§å…¨</h3>
            
            <!-- æ¶ˆæ¯ç»Ÿè®¡ -->
            <div class="card">
                <h4>ğŸ“Š æ¶ˆæ¯ç»Ÿè®¡</h4>
                <div class="stats-list" id="messageStats"></div>
                <div>å¯¹æ–¹é«˜é¢‘è¯ TOP 5:</div>
                <div id="topWords"></div>
            </div>
            
            <!-- ä¸€èµ·å¬æ­Œ -->
            <div class="card">
                <h4>ğŸ§ ä¸€èµ·å¬æ­Œ</h4>
                <input type="text" id="musicLinkInput" placeholder="ç²˜è´´ç½‘æ˜“äº‘/QQ/YouTubeé“¾æ¥" style="width:100%; padding:8px; border-radius:10px;">
                <button class="send-btn" style="margin:5px 0" onclick="addMusicLink()">æ·»åŠ é“¾æ¥</button>
                <div id="musicPlaylist" style="max-height:200px; overflow-y:auto; background:var(--bg-tertiary); border-radius:10px; padding:10px;"></div>
                <div id="musicEmbedArea" class="music-embed" style="margin:10px 0;"></div>
                <div class="flex-row" style="justify-content:center">
                    <div class="icon-btn" onclick="playPreviousMusic()">â®ï¸</div>
                    <div class="icon-btn" onclick="toggleMusicPlay()">â¯ï¸</div>
                    <div class="icon-btn" onclick="playNextMusic()">â­ï¸</div>
                    <div class="icon-btn" onclick="repeatCurrentMusic()">ğŸ”</div>
                </div>
            </div>

            <!-- å†³ç­–å¸ -->
            <div class="card">
                <h4>ğŸª™ å†³ç­–å¸</h4>
                <input type="text" id="decisionQuestion" class="decision-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜...">
                <div class="flex-row" style="justify-content:space-between;">
                    <button class="send-btn" onclick="flipDecisionCoin()">æ·å¸</button>
                    <span id="decisionResult" style="font-size:24px; font-weight:bold;">âšª</span>
                </div>
            </div>

            <!-- æ¯æ—¥è¿åŠ¿ -->
            <div class="card">
                <h4>â­ æ¯æ—¥è¿åŠ¿</h4>
                <p id="dailyFortune" style="font-size:20px;">ç‚¹å‡»æŠ½å–</p>
                <button class="send-btn" onclick="drawFortune()">æŠ½è¿åŠ¿</button>
            </div>

            <!-- å¡”ç½—å åœ -->
            <div class="card">
                <h4>ğŸ”® å¡”ç½—å åœ</h4>
                <button class="send-btn" style="width:100%; margin-bottom:15px;" onclick="drawTarotCard()">æŠ½ç‰Œ</button>
                <div id="tarotResult" class="tarot-card" style="display:none;">
                    <div id="tarotName" class="tarot-name"></div>
                    <div id="tarotMeaning" class="tarot-meaning"></div>
                </div>
            </div>

            <!-- æœˆç»è®°å½• -->
            <div class="card">
                <h4>ğŸŒ¸ æœˆç»è®°å½•</h4>
                <label>ä¸Šæ¬¡æ—¥æœŸ</label>
                <input type="date" id="lastPeriodDate" style="width:100%; padding:8px; margin:5px 0;">
                <label>å‘¨æœŸå¤©æ•°</label>
                <input type="number" id="cycleLength" value="28" min="20" max="40" style="width:100%; padding:8px; margin:5px 0;">
                <label>ç»æœŸæŒç»­å¤©æ•°</label>
                <input type="number" id="periodDuration" value="5" min="1" max="10" style="width:100%; padding:8px; margin:5px 0;">
                <button class="send-btn" onclick="savePeriod()">ä¿å­˜è®°å½•</button>
                <div id="periodPrediction" style="margin-top:10px; padding:8px; background:var(--bg-tertiary); border-radius:10px;"></div>
            </div>

            <!-- å¤‡å¿˜å½•ç‹¬ç«‹æ¿å— -->
            <div class="card">
                <h4>ğŸ’Œ å¤‡å¿˜å½• <button class="send-btn" onclick="openMemoSection()">è¿›å…¥</button></h4>
            </div>

            <!-- ä»Šæ—¥ä¹¦å•æ¨è -->
            <div class="card">
                <h4>ğŸ“š ä»Šæ—¥ä¹¦å•æ¨è</h4>
                <div class="flex-row">
                    <input type="text" id="bookInput" placeholder="æ·»åŠ ä¹¦ç±" style="flex:1; padding:8px;">
                    <button class="send-btn" onclick="addBook()">æ·»åŠ </button>
                </div>
                <textarea id="bulkBookInput" rows="2" placeholder="æ‰¹é‡å¯¼å…¥(ä¸€è¡Œä¸€æœ¬)" style="width:100%; padding:8px; margin:5px 0;"></textarea>
                <button class="send-btn" style="margin:5px 0" onclick="bulkAddBooks()">æ‰¹é‡å¯¼å…¥</button>
                <div id="bookList" style="max-height:150px; overflow-y:auto; margin:10px 0;"></div>
                <button class="send-btn" onclick="recommendBook()">ğŸ“– é™†æ²‰æ¨è</button>
                <span id="bookResult" style="margin-left:10px;"></span>
            </div>

            <!-- ä»Šæ—¥å¯ä»¥åš -->
            <div class="card">
                <h4>âœ¨ ä»Šæ—¥å¯ä»¥åš</h4>
                <div class="flex-row">
                    <input type="text" id="todoInput" placeholder="æ·»åŠ äº‹é¡¹" style="flex:1; padding:8px;">
                    <button class="send-btn" onclick="addTodo()">æ·»åŠ </button>
                </div>
                <div id="todoList" style="max-height:150px; overflow-y:auto; margin:10px 0;"></div>
                <button class="send-btn" onclick="pickRandomTodo()">éšæœºç­”æ¡ˆ</button>
                <span id="todoResult" style="margin-left:10px;"></span>
            </div>

            <!-- å–«èŒ¶åˆ¸è®¾ç½® -->
            <div class="card">
                <h4>ğŸ« å–«èŒ¶åˆ¸è®¾ç½®</h4>
                <div class="flex-row">
                    <input type="text" id="couponReplyInput" placeholder="å¯¹æ–¹å›å¤å†…å®¹" style="flex:1; padding:8px;">
                    <button class="send-btn" onclick="addCouponReply()">æ·»åŠ </button>
                </div>
                <div id="couponReplyList" style="max-height:150px; overflow-y:auto; margin:10px 0;"></div>
            </div>

            <!-- æ­Œæ›²ä¼ è®¯ -->
            <div class="card">
                <h4>ğŸµ æ­Œæ›²ä¼ è®¯</h4>
                <div class="flex-row">
                    <input type="number" id="customPlaylistCount" placeholder="æ­Œå•æ•°" style="flex:1; padding:8px;" min="1" max="2000">
                    <input type="number" id="customSongCount" placeholder="æ­Œæ›²æ•°" style="flex:1; padding:8px;" min="1" max="10000">
                </div>
                <button class="send-btn" style="margin:5px 0" onclick="customSongMessage()">éšæœºä¼ è®¯</button>
                <p id="songMessage" style="margin-top:10px; font-size:16px;">ç­‰å¾…...</p>
            </div>

            <button class="send-btn" style="width:100%; margin-top:15px" onclick="saveAllDailySettings()">ä¿å­˜æ‰€æœ‰æ—¥å¸¸è®¾ç½®</button>
        </div>
        
        <button class="send-btn" style="width:100%; margin-top:25px" onclick="saveAllSettings()">ğŸ’¾ ä¿å­˜å…¨éƒ¨è®¾ç½®</button>
    </div>

    <script>
        // ---------- å…¨å±€å˜é‡ ----------
        let currentSession = 'default';
        let sessions = JSON.parse(localStorage.getItem('sessions')) || [{ id: 'default', name: 'ä»Šæ—¥é—²èŠ', type: 'private' }];
        let groups = JSON.parse(localStorage.getItem('groups')) || [];
        let musicPlaylist = JSON.parse(localStorage.getItem('musicPlaylist')) || [];
        let currentMusicIndex = -1;
        
        // èŠå¤©è®°å½• - æŒ‰ä¼šè¯å­˜å‚¨
        let chatMessages = JSON.parse(localStorage.getItem('chatMessages')) || {
            default: []
        };
        
        // å­—å¡åº“åˆ†ç±»ç³»ç»Ÿ
        let cardCategories = JSON.parse(localStorage.getItem('cardCategories')) || {
            emoji: ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜­', 'ğŸ‘', 'ğŸ‰'],
            number: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
            character: {
                'å°ç†Š': ['ä½ å¥½', 'åœ¨å¹²å˜›', 'ä»Šå¤©æ€ä¹ˆæ ·', 'æ™šå®‰', 'æƒ³ä½ å•¦', 'åƒé¥­äº†å—', 'å¼€å¿ƒ', 'å¥½çš„'],
                'å°å…”': ['å—¨', 'å—¯å—¯', 'å¥½æ£’', 'â¤ï¸', 'å“ˆå“ˆ', 'çœŸçš„å—', 'ä¸é”™', 'æ”¶åˆ°']
            }
        };
        
        // å­—å¡æ¯”ä¾‹
        let cardRatios = JSON.parse(localStorage.getItem('cardRatios')) || {
            number: 25,
            emoji: 25,
            text: 25,
            image: 25
        };
        
        // è‡ªå®šä¹‰è¡¨æƒ…åŒ…
        let customEmojis = JSON.parse(localStorage.getItem('customEmojis')) || [];
        
        // é£Ÿç‰©ã€å¤‡å¿˜å½•ã€ç»æœŸã€çºªå¿µæ—¥ç­‰
        let foodItems = JSON.parse(localStorage.getItem('foodItems')) || ['ç«é”…','çƒ¤è‚‰','æ‹‰é¢','æ²™æ‹‰','æŠ«è¨','å¯¿å¸','æ±‰å ¡'];
        let memos = JSON.parse(localStorage.getItem('memos')) || [];
        let periodData = JSON.parse(localStorage.getItem('periodData')) || { lastDate: '', cycle: 28, duration: 5 };
        let anniversaries = JSON.parse(localStorage.getItem('anniversaries')) || [];
        let avatarVisible = true;
        let avatarSize = 40;
        let settings = JSON.parse(localStorage.getItem('settings')) || { quote: false, sound: false, readReceipt: true, typing: false };
        let bulkMessages = [];
        let currentImageData = null;
        let currentEmojiData = null;
        
        // æ‹ä¸€æ‹å›å¤åº“
        let patReplies = JSON.parse(localStorage.getItem('patReplies')) || ['æ‹äº†æ‹ä½ ', 'æ‘¸äº†æ‘¸å¤´', 'æˆ³äº†æˆ³ä½ ', 'æäº†æè„¸', 'ç»™äº†ä½ ä¸€ä¸ªæ‹¥æŠ±'];
        
        // å¯¹æ–¹çŠ¶æ€åº“
        let otherStatusList = JSON.parse(localStorage.getItem('otherStatusList')) || [
            'ä¼‘æ¯', 'å¥èº«', 'å·¥ä½œ', 'åº¦å‡', 'åƒé¥­', 'æ‚²ä¼¤', 'éš¾è¿‡', 
            'å¿«ä¹', 'æƒ³ä½ ', 'å¿™ç¢Œ', 'æ´—æ¼±', 'ç¡è§‰', 'é™ªåœ¨ä½ èº«è¾¹', 
            'æ€è€ƒ', 'åƒé†‹', 'æ‹…å¿ƒ', 'ğŸ¥º', 'å¿®å¿Œ'
        ];
        
        // æ”¶è—çš„å›å¤
        let favoriteReplies = JSON.parse(localStorage.getItem('favoriteReplies')) || [];
        
        // ä»Šæ—¥é—²èŠå›å¤æ¡æ•°è®¾ç½®
        let chatReplyRange = { min: 1, max: 3 };
        let bulkReplyRange = { min: 1, max: 3 };
        
        // ä¹¦ç±åˆ—è¡¨
        let bookList = JSON.parse(localStorage.getItem('bookList')) || ['å°ç‹å­', 'è§£å¿§æ‚è´§åº—', 'æ´»ç€', 'ç™¾å¹´å­¤ç‹¬', 'è¿½é£ç­çš„äºº'];
        
        // ä»Šæ—¥å¯ä»¥åšåˆ—è¡¨
        let todoList = JSON.parse(localStorage.getItem('todoList')) || ['çœ‹ä¹¦', 'è¿åŠ¨', 'åšé¥­', 'çœ‹ç”µå½±', 'æ•£æ­¥', 'å¬éŸ³ä¹'];
        
        // å–«èŒ¶åˆ¸å›å¤åº“
        let couponReplies = JSON.parse(localStorage.getItem('couponReplies')) || ['è°¢è°¢ä½ çš„åˆ¸', 'æ”¹å¤©ä¸€èµ·å»å§', 'å¥½è´´å¿ƒ', 'ä¸‹æ¬¡æˆ‘è¯·ä½ ', 'æ”¶åˆ°åˆ¸å•¦'];
        
        // é˜…è¯»å¿ƒå¾—åˆ—è¡¨
        let bookReviews = JSON.parse(localStorage.getItem('bookReviews')) || [];
        
        // æ‹çˆ±å¤©æ•°èµ·å§‹æ—¥æœŸ
        let loveStartDate = localStorage.getItem('loveStartDate') || new Date().toISOString().split('T')[0];
        
        // æ¶ˆæ¯ç»Ÿè®¡
        let messageStats = JSON.parse(localStorage.getItem('messageStats')) || { total: 0, me: 0, other: 0, firstDate: new Date().toISOString().split('T')[0], lastContact: new Date().toISOString().split('T')[0], wordCount: {} };
        
        // å½“å‰é•¿æŒ‰çš„æ¶ˆæ¯
        let longPressedMessage = null;
        let longPressedElement = null;

        // å¡”ç½—ç‰Œæ•°æ®
        const tarotCards = [
            { name: 'æ„šè€…', upright: 'æ–°çš„å¼€å§‹ï¼Œå†’é™©ï¼Œçº¯çœŸï¼Œè‡ªç”±å¥”æ”¾', reversed: 'é²è½ï¼Œæ„šè ¢ï¼Œä¸è´Ÿè´£ä»»ï¼Œåœæ»ä¸å‰' },
            { name: 'é­”æœ¯å¸ˆ', upright: 'åˆ›é€ åŠ›ï¼ŒæŠ€èƒ½ï¼Œä¸“æ³¨ï¼Œè¡ŒåŠ¨åŠ›', reversed: 'æ¬ºéª—ï¼Œæµªè´¹æ‰èƒ½ï¼Œä¼˜æŸ”å¯¡æ–­' },
            { name: 'å¥³ç¥­å¸', upright: 'ç›´è§‰ï¼Œæ™ºæ…§ï¼Œå†…åœ¨çš„å£°éŸ³', reversed: 'å‹æŠ‘ï¼Œå†·æ¼ ï¼Œç›´è§‰é—­å¡' },
            { name: 'å¥³çš‡', upright: 'ä¸°ç››ï¼Œåˆ›é€ åŠ›ï¼Œæ¯æ€§ï¼Œè‡ªç„¶', reversed: 'ä¾èµ–ï¼Œç¼ºä¹åˆ›é€ åŠ›ï¼Œå®¶åº­é—®é¢˜' },
            { name: 'çš‡å¸', upright: 'æƒå¨ï¼Œç¨³å®šï¼Œé¢†å¯¼åŠ›', reversed: 'ä¸“åˆ¶ï¼Œæ§åˆ¶æ¬²å¼ºï¼Œè½¯å¼±' },
            { name: 'æ•™çš‡', upright: 'ä¼ ç»Ÿï¼Œæ•™è‚²ï¼Œä¿¡ä»°ï¼ŒæŒ‡å¼•', reversed: 'å›ºæ‰§ï¼Œè¿‡åº¦ä¿å®ˆï¼Œä¸è‰¯æ•™å¯¼' },
            { name: 'æ‹äºº', upright: 'é€‰æ‹©ï¼Œçˆ±æƒ…ï¼Œå…³ç³»ï¼Œä»·å€¼è§‚', reversed: 'é”™è¯¯é€‰æ‹©ï¼Œåˆ†ç¦»ï¼Œä»·å€¼è§‚å†²çª' },
            { name: 'æˆ˜è½¦', upright: 'æ„å¿—åŠ›ï¼Œå†³å¿ƒï¼Œèƒœåˆ©ï¼Œæ§åˆ¶', reversed: 'å¤±æ§ï¼Œç¼ºä¹æ–¹å‘ï¼Œå†²çª' },
            { name: 'åŠ›é‡', upright: 'å†…åœ¨åŠ›é‡ï¼Œå‹‡æ°”ï¼Œè€å¿ƒ', reversed: 'è½¯å¼±ï¼Œè‡ªå‘ï¼Œæ»¥ç”¨æƒåŠ›' },
            { name: 'éšå£«', upright: 'å†…çœï¼Œç‹¬å¤„ï¼Œæ™ºæ…§ï¼ŒæŒ‡å¼•', reversed: 'å­¤ç‹¬ï¼Œå¤šç–‘ï¼Œé€ƒé¿ç°å®' },
            { name: 'å‘½è¿ä¹‹è½®', upright: 'è½¬å˜ï¼Œæœºé‡ï¼Œå‘½è¿ï¼Œå¾ªç¯', reversed: 'å„è¿ï¼ŒæŠ—æ‹’æ”¹å˜ï¼Œåœæ»' },
            { name: 'æ­£ä¹‰', upright: 'å…¬å¹³ï¼ŒçœŸç›¸ï¼Œå› æœï¼Œå¹³è¡¡', reversed: 'ä¸å…¬ï¼Œå¤±è¡¡ï¼Œé€ƒé¿è´£ä»»' },
            { name: 'åŠäºº', upright: 'æš‚åœï¼Œç‰ºç‰²ï¼Œæ–°è§†è§’', reversed: 'å¾’åŠ³æ— åŠŸï¼Œæ‹–å»¶ï¼Œä¸æ„¿ç‰ºç‰²' },
            { name: 'æ­»ç¥', upright: 'ç»“æŸï¼Œè½¬å˜ï¼Œæ–°ç”Ÿ', reversed: 'æŠ—æ‹’æ”¹å˜ï¼Œåœæ»ï¼Œæ­»å¯‚' },
            { name: 'èŠ‚åˆ¶', upright: 'å¹³è¡¡ï¼Œä¸­åº¸ï¼Œè°ƒå’Œ', reversed: 'å¤±è¡¡ï¼Œå†²çªï¼ŒæŒ¥éœ' },
            { name: 'æ¶é­”', upright: 'æŸç¼šï¼Œæ‰§ç€ï¼Œç‰©è´¨', reversed: 'è§£è„±ï¼Œæ‘†è„±æ§åˆ¶ï¼Œè§‰é†’' },
            { name: 'é«˜å¡”', upright: 'çªå˜ï¼Œå´©æºƒï¼Œè§‰é†’', reversed: 'é¿å…ç¾éš¾ï¼ŒæŠ—æ‹’æ”¹å˜' },
            { name: 'æ˜Ÿæ˜Ÿ', upright: 'å¸Œæœ›ï¼Œçµæ„Ÿï¼Œå®é™', reversed: 'ç»æœ›ï¼Œå¤±å»ä¿¡å¿ƒï¼Œå¹»æƒ³ç ´ç­' },
            { name: 'æœˆäº®', upright: 'ä¸å®‰ï¼Œå¹»æƒ³ï¼Œæ½œæ„è¯†', reversed: 'è¯¯è§£ï¼Œç„¦è™‘ï¼Œææƒ§æ¶ˆé€€' },
            { name: 'å¤ªé˜³', upright: 'æˆåŠŸï¼Œå¿«ä¹ï¼Œæ´»åŠ›', reversed: 'æš‚æ—¶çš„æŒ«æŠ˜ï¼Œç¼ºä¹çƒ­æƒ…' },
            { name: 'å®¡åˆ¤', upright: 'è§‰é†’ï¼Œé‡ç”Ÿï¼Œå®½æ•', reversed: 'è‡ªè´£ï¼Œæ€€ç–‘ï¼Œæ‹’ç»æ”¹å˜' },
            { name: 'ä¸–ç•Œ', upright: 'å®Œæˆï¼Œæˆå°±ï¼Œåœ†æ»¡', reversed: 'æœªå®Œæˆï¼Œåœæ»ï¼Œç¼ºä¹æˆå°±æ„Ÿ' }
        ];

        window.onload = function() {
            loadFromStorage();
            renderSessionBar();
            renderSessionList();
            renderGroupList();
            renderMusicPlaylist();
            renderFoodList();
            renderMemos();
            renderCustomEmojiGrid();
            renderAnniversaries();
            renderPatReplyList();
            renderStatusList();
            renderFavoritesList();
            renderBookList();
            renderTodoList();
            renderCouponReplyList();
            updateMessageStats();
            updateLoveDays();
            
            // åŠ è½½å½“å‰ä¼šè¯çš„èŠå¤©è®°å½•
            loadChatMessages(currentSession);
            
            document.getElementById('lastPeriodDate').value = periodData.lastDate || '';
            document.getElementById('cycleLength').value = periodData.cycle || 28;
            document.getElementById('periodDuration').value = periodData.duration || 5;
            document.getElementById('loveStartDate').value = loveStartDate;
            updateAllToggleButtons();
            
            // è®¾ç½®å¯¹æ–¹çŠ¶æ€å®šæ—¶éšæœºå˜åŒ–
            setInterval(changeOtherStatus, 30000);
            changeOtherStatus();
        };

        // ä¿å­˜èŠå¤©è®°å½•åˆ°localStorage
        function saveChatMessages() {
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
        }

        // åŠ è½½æŒ‡å®šä¼šè¯çš„èŠå¤©è®°å½•
        function loadChatMessages(sessionId) {
            let area = document.getElementById('chatMessages');
            area.innerHTML = '';
            
            if(sessionId === 'reading') {
                renderReadingSession();
                return;
            } else if(sessionId === 'coupon') {
                renderCouponSession();
                return;
            } else if(sessionId === 'memo') {
                openMemoSection();
                return;
            }
            
            let messages = chatMessages[sessionId] || [];
            messages.forEach(msg => {
                if(msg.type === 'text') {
                    addMessage(msg.sender, msg.text, msg.isMe, false);
                } else if(msg.type === 'image') {
                    addImageMessage(msg.sender, msg.src, msg.isMe, false);
                } else if(msg.type === 'pat') {
                    addPatMessage(msg.sender, msg.text, msg.isMe, false);
                }
            });
        }

        // ä¿®æ”¹addMessageå‡½æ•°ï¼Œå¢åŠ ä¿å­˜åŠŸèƒ½
        function addMessage(sender, text, isMe, shouldSave = true) {
            let area = document.getElementById('chatMessages');
            let msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            if(isMe) msgDiv.classList.add('me'); else msgDiv.classList.add('other');
            msgDiv.innerText = text;
            area.appendChild(msgDiv);
            area.scrollTop = area.scrollHeight;
            
            // ä¿å­˜åˆ°èŠå¤©è®°å½•
            if(shouldSave && currentSession !== 'reading' && currentSession !== 'coupon' && currentSession !== 'memo') {
                if(!chatMessages[currentSession]) {
                    chatMessages[currentSession] = [];
                }
                chatMessages[currentSession].push({
                    type: 'text',
                    sender: sender,
                    text: text,
                    isMe: isMe,
                    timestamp: Date.now()
                });
                saveChatMessages();
            }
            
            // è®¾ç½®é•¿æŒ‰äº‹ä»¶
            if(!isMe) {
                setupMessageLongPress(msgDiv, text);
            }
        }

        // ä¿®æ”¹addImageMessageå‡½æ•°ï¼Œå¢åŠ ä¿å­˜åŠŸèƒ½
        function addImageMessage(sender, imgSrc, isMe, shouldSave = true) {
            let area = document.getElementById('chatMessages');
            let msgDiv = document.createElement('div');
            msgDiv.classList.add('message', 'image-message');
            if(isMe) msgDiv.classList.add('me'); else msgDiv.classList.add('other');
            msgDiv.innerHTML = `<img src="${imgSrc}" alt="å›¾ç‰‡" style="max-width:100%; border-radius:15px;">`;
            area.appendChild(msgDiv);
            area.scrollTop = area.scrollHeight;
            
            // ä¿å­˜åˆ°èŠå¤©è®°å½•
            if(shouldSave && currentSession !== 'reading' && currentSession !== 'coupon' && currentSession !== 'memo') {
                if(!chatMessages[currentSession]) {
                    chatMessages[currentSession] = [];
                }
                chatMessages[currentSession].push({
                    type: 'image',
                    sender: sender,
                    src: imgSrc,
                    isMe: isMe,
                    timestamp: Date.now()
                });
                saveChatMessages();
            }
        }

        // ä¿®æ”¹addPatMessageå‡½æ•°ï¼Œå¢åŠ ä¿å­˜åŠŸèƒ½
        function addPatMessage(sender, text, isMe, shouldSave = true) {
            let area = document.getElementById('chatMessages');
            let msgDiv = document.createElement('div');
            msgDiv.classList.add('message', 'pat');
            if(isMe) msgDiv.classList.add('me'); else msgDiv.classList.add('other');
            msgDiv.innerText = text;
            area.appendChild(msgDiv);
            area.scrollTop = area.scrollHeight;
            
            // ä¿å­˜åˆ°èŠå¤©è®°å½•
            if(shouldSave && currentSession !== 'reading' && currentSession !== 'coupon' && currentSession !== 'memo') {
                if(!chatMessages[currentSession]) {
                    chatMessages[currentSession] = [];
                }
                chatMessages[currentSession].push({
                    type: 'pat',
                    sender: sender,
                    text: text,
                    isMe: isMe,
                    timestamp: Date.now()
                });
                saveChatMessages();
            }
        }

        // è®¾ç½®é•¿æŒ‰äº‹ä»¶
        function setupMessageLongPress(element, text) {
            let pressTimer;
            element.addEventListener('touchstart', (e) => {
                e.preventDefault();
                pressTimer = setTimeout(() => {
                    longPressedMessage = text;
                    longPressedElement = element;
                    element.classList.add('long-press');
                    document.getElementById('quoteModal').style.display = 'block';
                }, 500);
            });
            element.addEventListener('touchend', () => {
                clearTimeout(pressTimer);
                element.classList.remove('long-press');
            });
            element.addEventListener('touchmove', () => {
                clearTimeout(pressTimer);
                element.classList.remove('long-press');
            });
        }

        function quoteMessage() {
            if(longPressedMessage) {
                document.getElementById('chatInput').value = 'å¼•ç”¨: "' + longPressedMessage + '" ';
                document.getElementById('quoteModal').style.display = 'none';
                if(longPressedElement) {
                    longPressedElement.classList.remove('long-press');
                }
            }
        }

        function favoriteMessage() {
            if(longPressedMessage) {
                favoriteReplies.push(longPressedMessage);
                localStorage.setItem('favoriteReplies', JSON.stringify(favoriteReplies));
                renderFavoritesList();
                document.getElementById('quoteModal').style.display = 'none';
                if(longPressedElement) {
                    longPressedElement.classList.remove('long-press');
                }
            }
        }

        function closeQuoteModal() {
            document.getElementById('quoteModal').style.display = 'none';
            if(longPressedElement) {
                longPressedElement.classList.remove('long-press');
            }
        }

        // éšæœºæ”¹å˜å¯¹æ–¹çŠ¶æ€
        function changeOtherStatus() {
            const randomIndex = Math.floor(Math.random() * otherStatusList.length);
            document.getElementById('otherStatus').innerText = otherStatusList[randomIndex];
        }

        // æ·»åŠ æ–°çŠ¶æ€
        function addStatus() {
            let newStatus = document.getElementById('newStatus').value.trim();
            if(newStatus) {
                otherStatusList.push(newStatus);
                localStorage.setItem('otherStatusList', JSON.stringify(otherStatusList));
                renderStatusList();
                document.getElementById('newStatus').value = '';
            }
        }

        function renderStatusList() {
            let list = document.getElementById('statusList');
            if(!list) return;
            list.innerHTML = '';
            otherStatusList.forEach((status, idx) => {
                let div = document.createElement('div');
                div.className = 'flex-row';
                div.innerHTML = `<span>${status}</span><button class="send-btn" onclick="removeStatus(${idx})">åˆ é™¤</button>`;
                list.appendChild(div);
            });
        }

        function removeStatus(idx) {
            otherStatusList.splice(idx, 1);
            localStorage.setItem('otherStatusList', JSON.stringify(otherStatusList));
            renderStatusList();
        }

        // ä¼šè¯ç®¡ç†
        function renderSessionBar() {
            let bar = document.getElementById('sessionBar');
            bar.innerHTML = '';
            sessions.forEach(session => {
                let tab = document.createElement('div');
                tab.className = 'session-tab' + (session.id === currentSession ? ' active' : '');
                tab.dataset.session = session.id;
                tab.onclick = () => switchSession(session.id);
                if(session.type === 'group') {
                    let group = groups.find(g => g.id === session.id);
                    let memberCount = group ? group.members.length : 0;
                    tab.innerHTML = 'ğŸ‘¥ ' + session.name + ' (' + memberCount + ')';
                } else {
                    tab.innerHTML = 'ğŸ’¬ ' + session.name;
                }
                bar.appendChild(tab);
            });
            // æ·»åŠ é˜…è¯»å¿ƒå¾—å’Œå–«èŒ¶åˆ¸æ¿å—
            let readingTab = document.createElement('div');
            readingTab.className = 'session-tab' + (currentSession === 'reading' ? ' active' : '');
            readingTab.dataset.session = 'reading';
            readingTab.onclick = () => switchSession('reading');
            readingTab.innerHTML = 'ğŸ“– é˜…è¯»å¿ƒå¾—';
            bar.appendChild(readingTab);
            
            let couponTab = document.createElement('div');
            couponTab.className = 'session-tab' + (currentSession === 'coupon' ? ' active' : '');
            couponTab.dataset.session = 'coupon';
            couponTab.onclick = () => switchSession('coupon');
            couponTab.innerHTML = 'ğŸ« å–«èŒ¶åˆ¸';
            bar.appendChild(couponTab);
        }

        function switchSession(sessionId) {
            currentSession = sessionId;
            renderSessionBar();
            loadChatMessages(sessionId);
        }

        function renderReadingSession() {
            let msgArea = document.getElementById('chatMessages');
            msgArea.innerHTML = '';
            
            bookReviews.forEach(review => {
                let msgDiv = document.createElement('div');
                msgDiv.classList.add('message', 'book-review');
                msgDiv.innerText = review.text;
                msgArea.appendChild(msgDiv);
                
                if(review.viewed) {
                    let viewedDiv = document.createElement('div');
                    viewedDiv.classList.add('read-receipt');
                    viewedDiv.innerText = 'å¯¹æ–¹å·²çœ‹è¿‡';
                    msgArea.appendChild(viewedDiv);
                }
            });
            
            // æ·»åŠ è¾“å…¥åŒºåŸŸ
            let inputDiv = document.createElement('div');
            inputDiv.style.display = 'flex';
            inputDiv.style.gap = '10px';
            inputDiv.style.marginTop = '10px';
            inputDiv.innerHTML = `
                <input type="text" id="readingInput" class="input-field" placeholder="å†™ä¸‹ä½ çš„é˜…è¯»å¿ƒå¾—...">
                <button class="send-btn" onclick="postReading()">å‘è¡¨</button>
            `;
            msgArea.appendChild(inputDiv);
        }

        function postReading() {
            let text = document.getElementById('readingInput').value.trim();
            if(!text) return;
            
            let review = {
                text: text,
                viewed: false,
                timestamp: Date.now(),
                id: 'review_' + Date.now()
            };
            bookReviews.unshift(review);
            localStorage.setItem('bookReviews', JSON.stringify(bookReviews));
            
            renderReadingSession();
            document.getElementById('readingInput').value = '';
            
            // æ¨¡æ‹Ÿ48å°æ—¶å†…å¯¹æ–¹å·²çœ‹å’Œå›å¤
            setTimeout(() => {
                review.viewed = true;
                localStorage.setItem('bookReviews', JSON.stringify(bookReviews));
                renderReadingSession();
                
                // éšæœºå›å¤10ä¸ªå­—å¡ + éšæœºä¸€æ¡å›ºå®šå›å¤
                setTimeout(() => {
                    let allCards = getAllCards();
                    let cards = [];
                    for(let i=0; i<10; i++) {
                        cards.push(allCards[Math.floor(Math.random() * allCards.length)]);
                    }
                    let fixedReplies = ['å¾ˆæœ‰è¶£çš„æ„Ÿæƒ³', 'æƒ³å’Œä½ ç»§ç»­èŠèŠè¿™æœ¬ä¹¦çš„æƒ…èŠ‚', 'ä½ å–œæ¬¢è¿™æœ¬ä¹¦å—ï¼Ÿ', 'æƒ³å’Œä½ ä¸€èµ·çœ‹ä¹¦', 'ä»ä½ çš„åˆ†äº«ä¸­å¾—çŸ¥è¿™æœ¬ä¹¦ä¼¼ä¹å¾ˆç²¾å½©'];
                    let fixed = fixedReplies[Math.floor(Math.random() * fixedReplies.length)];
                    let replyText = cards.join(' ') + ' ' + fixed;
                    
                    let replyDiv = document.createElement('div');
                    replyDiv.classList.add('message', 'book-reply');
                    replyDiv.innerText = replyText;
                    document.getElementById('chatMessages').appendChild(replyDiv);
                }, 2000);
            }, 5000);
        }

        function renderCouponSession() {
            let msgArea = document.getElementById('chatMessages');
            msgArea.innerHTML = '';
            
            // å…ˆæ˜¾ç¤ºå·²æœ‰çš„å–«èŒ¶åˆ¸è®°å½•
            if(couponMessages && couponMessages.length > 0) {
                couponMessages.forEach(coupon => {
                    let couponDiv = document.createElement('div');
                    couponDiv.classList.add('message', 'coupon');
                    couponDiv.innerText = coupon.text;
                    msgArea.appendChild(couponDiv);
                    
                    if(coupon.viewed) {
                        let viewedDiv = document.createElement('div');
                        viewedDiv.classList.add('read-receipt');
                        viewedDiv.innerText = 'å¯¹æ–¹å·²çœ‹è¿‡';
                        msgArea.appendChild(viewedDiv);
                    }
                    
                    if(coupon.replies && coupon.replies.length > 0) {
                        coupon.replies.forEach(reply => {
                            let replyDiv = document.createElement('div');
                            replyDiv.classList.add('message', 'coupon-reply');
                            replyDiv.innerText = reply;
                            msgArea.appendChild(replyDiv);
                        });
                    }
                });
            }
            
            // æ˜¾ç¤ºçº¸å¼ ç•Œé¢ (æ”¾å¤§ç‰ˆ)
            let paperDiv = document.createElement('div');
            paperDiv.classList.add('message', 'coupon');
            paperDiv.style.padding = '30px 20px';
            paperDiv.style.width = '95%';
            paperDiv.style.maxWidth = '450px';
            paperDiv.style.margin = '10px auto';
            paperDiv.innerHTML = `
                <textarea id="couponContent" rows="6" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å–«èŒ¶åˆ¸å†…å®¹..." style="width:100%; padding:15px; border-radius:15px; font-size:16px; border:2px solid var(--border-color); background:var(--bg-secondary); color:var(--text-primary); margin-bottom:15px;"></textarea>
                <div style="display:flex; gap:15px; justify-content:center;">
                    <button class="send-btn" style="flex:1; padding:12px;" onclick="sendCoupon()">é€å‡º</button>
                    <button class="send-btn" style="flex:1; padding:12px;" onclick="cancelCoupon()">å–æ¶ˆ</button>
                </div>
            `;
            msgArea.appendChild(paperDiv);
        }

        // å­˜å‚¨å–«èŒ¶åˆ¸æ¶ˆæ¯
        let couponMessages = JSON.parse(localStorage.getItem('couponMessages')) || [];

        function sendCoupon() {
            let text = document.getElementById('couponContent').value.trim();
            if(!text) return;
            
            // åˆ›å»ºæ–°çš„å–«èŒ¶åˆ¸è®°å½•
            let coupon = {
                text: text,
                viewed: false,
                timestamp: Date.now(),
                id: 'coupon_' + Date.now(),
                replies: []
            };
            
            couponMessages.unshift(coupon);
            localStorage.setItem('couponMessages', JSON.stringify(couponMessages));
            
            // é‡æ–°æ¸²æŸ“é¡µé¢ï¼Œåªæ˜¾ç¤ºèŠå¤©è®°å½•ï¼Œä¸æ˜¾ç¤ºçº¸å¼ æ¡†
            renderCouponSessionWithoutPaper();
            
            // æ¨¡æ‹Ÿ48å°æ—¶å†…å·²è¯»å’Œå›å¤
            setTimeout(() => {
                coupon.viewed = true;
                localStorage.setItem('couponMessages', JSON.stringify(couponMessages));
                
                // éšæœºå›å¤1-3æ¡
                setTimeout(() => {
                    let replyCount = Math.floor(Math.random() * 3) + 1;
                    for(let i=0; i<replyCount; i++) {
                        let reply = couponReplies[Math.floor(Math.random() * couponReplies.length)];
                        coupon.replies.push(reply);
                    }
                    localStorage.setItem('couponMessages', JSON.stringify(couponMessages));
                    renderCouponSessionWithoutPaper();
                }, 2000);
            }, 5000);
        }

        function renderCouponSessionWithoutPaper() {
            let msgArea = document.getElementById('chatMessages');
            msgArea.innerHTML = '';
            
            // åªæ˜¾ç¤ºå–«èŒ¶åˆ¸è®°å½•ï¼Œä¸æ˜¾ç¤ºçº¸å¼ æ¡†
            if(couponMessages && couponMessages.length > 0) {
                couponMessages.forEach(coupon => {
                    let couponDiv = document.createElement('div');
                    couponDiv.classList.add('message', 'coupon');
                    couponDiv.innerText = coupon.text;
                    msgArea.appendChild(couponDiv);
                    
                    if(coupon.viewed) {
                        let viewedDiv = document.createElement('div');
                        viewedDiv.classList.add('read-receipt');
                        viewedDiv.innerText = 'å¯¹æ–¹å·²çœ‹è¿‡';
                        msgArea.appendChild(viewedDiv);
                    }
                    
                    if(coupon.replies && coupon.replies.length > 0) {
                        coupon.replies.forEach(reply => {
                            let replyDiv = document.createElement('div');
                            replyDiv.classList.add('message', 'coupon-reply');
                            replyDiv.innerText = reply;
                            msgArea.appendChild(replyDiv);
                        });
                    }
                });
            }
        }

        function cancelCoupon() {
            renderCouponSessionWithoutPaper();
        }

        function getAllCards() {
            let cards = [];
            for(let i=0; i<cardRatios.number; i++) cards.push(...cardCategories.number);
            for(let i=0; i<cardRatios.emoji; i++) cards.push(...cardCategories.emoji);
            for(let i=0; i<cardRatios.text; i++) {
                Object.values(cardCategories.character).forEach(arr => cards.push(...arr));
            }
            for(let i=0; i<cardRatios.image; i++) cards.push(...customEmojis);
            return cards;
        }

        function createNewSession() {
            let name = document.getElementById('newSessionName').value.trim();
            if(name) {
                let newSession = { id: 'session_' + Date.now(), name: name, type: 'private' };
                sessions.push(newSession);
                chatMessages[newSession.id] = [];
                localStorage.setItem('sessions', JSON.stringify(sessions));
                saveChatMessages();
                renderSessionBar();
                renderSessionList();
                document.getElementById('newSessionName').value = '';
            }
        }

        function renderSessionList() {
            let list = document.getElementById('sessionList');
            if(!list) return;
            list.innerHTML = '';
            sessions.forEach((session, idx) => {
                if(session.id !== 'default') {
                    let div = document.createElement('div');
                    div.className = 'flex-row';
                    div.innerHTML = `<span>${session.name}</span><button class="send-btn" onclick="deleteSession('${session.id}')">åˆ é™¤</button>`;
                    list.appendChild(div);
                }
            });
        }

        function deleteSession(sessionId) {
            sessions = sessions.filter(s => s.id !== sessionId);
            delete chatMessages[sessionId];
            if(currentSession === sessionId) currentSession = 'default';
            localStorage.setItem('sessions', JSON.stringify(sessions));
            saveChatMessages();
            renderSessionBar();
            renderSessionList();
            loadChatMessages(currentSession);
        }

        // ç¾¤èŠç®¡ç†
        function createGroupChat() {
            let groupName = document.getElementById('newGroupName').value.trim();
            if(groupName) {
                let newGroup = {
                    id: 'group_' + Date.now(),
                    name: groupName,
                    members: [{ name: 'å°ç†Š', cards: [] }]
                };
                groups.push(newGroup);
                sessions.push({ id: newGroup.id, name: groupName, type: 'group' });
                chatMessages[newGroup.id] = [];
                localStorage.setItem('groups', JSON.stringify(groups));
                localStorage.setItem('sessions', JSON.stringify(sessions));
                saveChatMessages();
                renderSessionBar();
                renderGroupList();
                document.getElementById('newGroupName').value = '';
            }
        }

        function renderGroupList() {
            let list = document.getElementById('groupList');
            if(!list) return;
            list.innerHTML = '';
            groups.forEach((group, idx) => {
                let div = document.createElement('div');
                div.className = 'group-member';
                div.innerHTML = `
                    <div style="flex:1">
                        <strong>${group.name}</strong>
                        <div>æˆå‘˜: ${group.members.map(m => m.name).join(', ')}</div>
                    </div>
                    <button class="send-btn" onclick="addGroupMember('${group.id}')">â•</button>
                    <button class="send-btn" onclick="removeGroupMember('${group.id}')">â–</button>
                    <button class="send-btn" onclick="deleteGroup('${group.id}')">åˆ é™¤</button>
                `;
                list.appendChild(div);
            });
        }

        function addGroupMember(groupId) {
            let group = groups.find(g => g.id === groupId);
            if(group) {
                let newMember = prompt('è¾“å…¥æ–°æˆå‘˜åç§°');
                if(newMember) {
                    group.members.push({ name: newMember, cards: [] });
                    if(!cardCategories.character[newMember]) {
                        cardCategories.character[newMember] = [];
                    }
                    localStorage.setItem('groups', JSON.stringify(groups));
                    localStorage.setItem('cardCategories', JSON.stringify(cardCategories));
                    renderGroupList();
                }
            }
        }

        function removeGroupMember(groupId) {
            let group = groups.find(g => g.id === groupId);
            if(group && group.members.length > 1) {
                let memberName = prompt('è¾“å…¥è¦åˆ é™¤çš„æˆå‘˜åç§°');
                let index = group.members.findIndex(m => m.name === memberName);
                if(index !== -1) {
                    group.members.splice(index, 1);
                    localStorage.setItem('groups', JSON.stringify(groups));
                    renderGroupList();
                }
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä½æˆå‘˜');
            }
        }

        function deleteGroup(groupId) {
            groups = groups.filter(g => g.id !== groupId);
            sessions = sessions.filter(s => s.id !== groupId);
            delete chatMessages[groupId];
            localStorage.setItem('groups', JSON.stringify(groups));
            localStorage.setItem('sessions', JSON.stringify(sessions));
            saveChatMessages();
            renderSessionBar();
            renderGroupList();
        }

        // è‡ªå®šä¹‰è¡¨æƒ…åŒ…
        function openCustomEmojiModal() {
            document.getElementById('customEmojiModal').classList.add('show');
            renderCustomEmojiGrid();
        }

        function closeCustomEmojiModal() {
            document.getElementById('customEmojiModal').classList.remove('show');
        }

        function previewCustomEmoji(event) {
            let file = event.target.files[0];
            if(file) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    currentEmojiData = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function addCustomEmoji() {
            if(currentEmojiData) {
                customEmojis.push(currentEmojiData);
                localStorage.setItem('customEmojis', JSON.stringify(customEmojis));
                renderCustomEmojiGrid();
                currentEmojiData = null;
                document.getElementById('customEmojiFile').value = '';
            }
        }

        function renderCustomEmojiGrid() {
            let grid = document.getElementById('customEmojiGrid');
            if(!grid) return;
            grid.innerHTML = '';
            customEmojis.forEach((imgData, idx) => {
                let div = document.createElement('div');
                div.className = 'custom-emoji-item';
                div.innerHTML = `<img src="${imgData}" onclick="sendCustomEmoji('${imgData}')"><button onclick="removeCustomEmoji(${idx})">âœ•</button>`;
                grid.appendChild(div);
            });
        }

        function sendCustomEmoji(imgData) {
            addImageMessage('me', imgData, true);
            closeCustomEmojiModal();
            simulateOtherReply();
        }

        function removeCustomEmoji(idx) {
            customEmojis.splice(idx, 1);
            localStorage.setItem('customEmojis', JSON.stringify(customEmojis));
            renderCustomEmojiGrid();
        }

        // æ‹ä¸€æ‹
        function openPatModal() { document.getElementById('patModal').classList.add('show'); }
        function closePatModal() { document.getElementById('patModal').classList.remove('show'); document.getElementById('patInput').value = ''; }
        
        function sendPat() {
            let text = document.getElementById('patInput').value.trim();
            if(!text) text = 'æ‹äº†æ‹ä½ ';
            let otherName = document.getElementById('otherName').innerText;
            addPatMessage('me', 'âœ‹ ä½ æ‹äº†æ‹ ' + otherName + 'ï¼š' + text, true);
            closePatModal();
            
            setTimeout(() => {
                let reply = patReplies[Math.floor(Math.random() * patReplies.length)];
                addPatMessage('other', 'âœ‹ ' + otherName + ' ' + reply, false);
            }, 600);
        }

        function addPatReply() {
            let reply = document.getElementById('newPatReply').value.trim();
            if(reply) {
                patReplies.push(reply);
                localStorage.setItem('patReplies', JSON.stringify(patReplies));
                renderPatReplyList();
                document.getElementById('newPatReply').value = '';
            }
        }

        function renderPatReplyList() {
            let list = document.getElementById('patReplyList');
            if(!list) return;
            list.innerHTML = '';
            patReplies.forEach((reply, idx) => {
                let div = document.createElement('div');
                div.className = 'flex-row';
                div.innerHTML = `<span>${reply}</span><button class="send-btn" onclick="removePatReply(${idx})">åˆ é™¤</button>`;
                list.appendChild(div);
            });
        }

        function removePatReply(idx) {
            patReplies.splice(idx, 1);
            localStorage.setItem('patReplies', JSON.stringify(patReplies));
            renderPatReplyList();
        }

        // æ›´æ–°å›å¤æ¡æ•°è®¾ç½®
        function updateChatReplyCount(value) {
            let [min, max] = value.split('-').map(Number);
            chatReplyRange = { min, max };
        }

        function updateBulkReplyCount(value) {
            let [min, max] = value.split('-').map(Number);
            bulkReplyRange = { min, max };
        }

        // æ¨¡æ‹Ÿå¯¹æ–¹å›å¤
        function simulateOtherReply() {
            if(settings.typing) {
                let typingDiv = document.createElement('div');
                typingDiv.classList.add('typing-indicator');
                typingDiv.innerText = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
                document.getElementById('chatMessages').appendChild(typingDiv);
            }
            
            let minDelay = parseFloat(document.getElementById('minReplyDelay').value) * 1000;
            let maxDelay = parseFloat(document.getElementById('maxReplyDelay').value) * 1000;
            let delay = Math.random() * (maxDelay - minDelay) + minDelay;
            
            setTimeout(() => {
                if(settings.typing) {
                    document.querySelector('.typing-indicator')?.remove();
                }
                
                let range = currentSession === 'default' ? chatReplyRange : bulkReplyRange;
                let count = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
                let allCards = getAllCards();
                
                for(let i=0; i<count; i++) {
                    let reply = '';
                    for(let j=0; j<3; j++) {
                        reply += allCards[Math.floor(Math.random() * allCards.length)] + ' ';
                    }
                    addMessage('other', reply, false);
                }
                
                messageStats.other += count;
                messageStats.total += count;
                messageStats.lastContact = new Date().toISOString().split('T')[0];
                localStorage.setItem('messageStats', JSON.stringify(messageStats));
                updateMessageStats();
            }, delay);
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            let input = document.getElementById('chatInput');
            let text = input.value.trim();
            if(text) {
                addMessage('me', text, true);
                input.value = '';
                
                messageStats.me++;
                messageStats.total++;
                localStorage.setItem('messageStats', JSON.stringify(messageStats));
                updateMessageStats();
                
                let words = text.split(/\s+/);
                words.forEach(word => {
                    if(word.length > 1) {
                        messageStats.wordCount[word] = (messageStats.wordCount[word] || 0) + 1;
                    }
                });
                
                if(currentSession === 'default' || currentSession.startsWith('session') || currentSession.startsWith('group')) {
                    simulateOtherReply();
                }
                
                // ä¿®å¤å·²è¯»å›æ‰§ - ç¡®ä¿æ˜¾ç¤ºåœ¨æ¶ˆæ¯ä¸‹æ–¹
                if(settings.readReceipt) {
                    setTimeout(() => {
                        let lastMsg = document.querySelector('.message.me:last-child');
                        if(lastMsg) {
                            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å·²è¯»å›æ‰§
                            let nextElement = lastMsg.nextElementSibling;
                            if(!nextElement || !nextElement.classList.contains('read-receipt')) {
                                let receipt = document.createElement('div');
                                receipt.classList.add('read-receipt');
                                receipt.innerText = 'å·²è¯»';
                                lastMsg.parentNode.insertBefore(receipt, lastMsg.nextSibling);
                            }
                        }
                    }, 2000);
                }
            }
        }

        // æ›´æ–°æ¶ˆæ¯ç»Ÿè®¡æ˜¾ç¤º
        function updateMessageStats() {
            document.getElementById('totalMsgCount').innerText = messageStats.total || 0;
            document.getElementById('myMsgCount').innerText = messageStats.me || 0;
            
            let statsDiv = document.getElementById('messageStats');
            if(statsDiv) {
                statsDiv.innerHTML = `
                    <div>æ€»æ¶ˆæ¯æ•°: ${messageStats.total || 0}</div>
                    <div>æˆ‘å‘é€çš„: ${messageStats.me || 0}</div>
                    <div>åˆæ¬¡ç›¸é‡: ${messageStats.firstDate || 'ä»Šå¤©'}</div>
                    <div>æœ€è¿‘è”ç»œ: ${messageStats.lastContact || 'ä»Šå¤©'}</div>
                `;
            }
            
            let words = Object.entries(messageStats.wordCount || {})
                .sort((a,b) => b[1] - a[1])
                .slice(0,5);
            let topWordsDiv = document.getElementById('topWords');
            if(topWordsDiv) {
                topWordsDiv.innerHTML = words.map(w => `${w[0]} (${w[1]}æ¬¡)`).join('<br>');
            }
        }

        // æ›´æ–°æ‹çˆ±å¤©æ•°
        function updateLoveDays() {
            let start = new Date(loveStartDate);
            let today = new Date();
            let diffTime = Math.abs(today - start);
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            let otherName = document.getElementById('otherName').innerText;
            document.getElementById('loveDaysDisplay').innerText = `å’Œ${otherName}æ‹çˆ±çš„ç¬¬ ${diffDays} å¤©`;
        }

        function adjustLoveDaysSize(size) {
            document.documentElement.style.setProperty('--love-days-size', size + 'px');
        }

        // å¡”ç½—å åœ
        function drawTarotCard() {
            const randomIndex = Math.floor(Math.random() * tarotCards.length);
            const card = tarotCards[randomIndex];
            const isUpright = Math.random() > 0.5;
            const position = isUpright ? 'æ­£ä½' : 'é€†ä½';
            const meaning = isUpright ? card.upright : card.reversed;
            
            document.getElementById('tarotName').innerText = card.name + ' (' + position + ')';
            document.getElementById('tarotMeaning').innerText = meaning;
            document.getElementById('tarotResult').style.display = 'block';
            addMessage('me', 'ğŸ”® æŠ½åˆ°äº†å¡”ç½—ç‰Œï¼š' + card.name + position + ' - ' + meaning, true);
        }

        // æœˆç»é¢„æµ‹
        function savePeriod() {
            periodData.lastDate = document.getElementById('lastPeriodDate').value;
            periodData.cycle = parseInt(document.getElementById('cycleLength').value) || 28;
            periodData.duration = parseInt(document.getElementById('periodDuration').value) || 5;
            localStorage.setItem('periodData', JSON.stringify(periodData));
            
            if(periodData.lastDate) {
                let last = new Date(periodData.lastDate);
                let next = new Date(last);
                next.setDate(last.getDate() + periodData.cycle);
                let today = new Date();
                let daysUntil = Math.ceil((next - today) / (1000 * 60 * 60 * 24));
                
                let prediction = `ä¸‹æ¬¡ç»æœŸé¢„è®¡åœ¨ ${next.toLocaleDateString()}ï¼Œè¿˜æœ‰ ${daysUntil} å¤©`;
                if(daysUntil <= 7) {
                    prediction += ' âš ï¸ å³å°†åˆ°æ¥';
                }
                document.getElementById('periodPrediction').innerText = prediction;
            }
            alert('å‘¨æœŸå·²ä¿å­˜');
        }

        // å¤‡å¿˜å½•ç‹¬ç«‹æ¿å—
        function openMemoSection() {
            currentSession = 'memo';
            let msgArea = document.getElementById('chatMessages');
            msgArea.innerHTML = '';
            
            memos.forEach(memo => {
                let msgDiv = document.createElement('div');
                msgDiv.classList.add('message', 'book-review');
                msgDiv.id = memo.id;
                msgDiv.innerHTML = `
                    <div>${memo.text} [${memo.privacy}]</div>
                    ${memo.viewedByOther ? '<div class="read-receipt">å¯¹æ–¹å·²çœ‹è¿‡</div>' : ''}
                    <button class="send-btn" onclick="deleteMemo('${memo.id}')">åˆ é™¤</button>
                `;
                msgArea.appendChild(msgDiv);
                
                if(memo.replies && memo.replies.length > 0) {
                    memo.replies.forEach(reply => {
                        let replyDiv = document.createElement('div');
                        replyDiv.classList.add('message', 'memo-reply');
                        replyDiv.innerText = reply.text;
                        msgArea.appendChild(replyDiv);
                    });
                }
            });
            
            let inputDiv = document.createElement('div');
            inputDiv.style.display = 'flex';
            inputDiv.style.gap = '10px';
            inputDiv.style.marginTop = '10px';
            inputDiv.innerHTML = `
                <textarea id="memoContent" rows="2" placeholder="è®°å½•å¿ƒæƒ…..." style="flex:1; padding:8px;"></textarea>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <label><input type="radio" name="memoPrivacy" value="public" checked> å…¬å¼€</label>
                    <label><input type="radio" name="memoPrivacy" value="private"> ç§å¯†</label>
                    <button class="send-btn" onclick="postMemoFromSection()">å‘å¸ƒ</button>
                </div>
            `;
            msgArea.appendChild(inputDiv);
        }

        function postMemoFromSection() {
            let text = document.getElementById('memoContent').value.trim();
            if(!text) return;
            let privacy = document.querySelector('input[name="memoPrivacy"]:checked').value;
            let memo = { 
                text: text, 
                privacy: privacy, 
                viewedByOther: false, 
                timestamp: Date.now(), 
                id: 'memo_' + Date.now(),
                replies: [] 
            };
            memos.unshift(memo);
            localStorage.setItem('memos', JSON.stringify(memos));
            openMemoSection();
            
            if(privacy === 'public') {
                setTimeout(() => {
                    memo.viewedByOther = true;
                    let allCards = getAllCards();
                    let cards = [];
                    for(let i=0; i<10; i++) {
                        cards.push(allCards[Math.floor(Math.random() * allCards.length)]);
                    }
                    let replyText = 'ğŸ“ ' + cards.join(' ');
                    
                    memo.replies.push({ text: replyText, timestamp: Date.now() });
                    localStorage.setItem('memos', JSON.stringify(memos));
                    openMemoSection();
                }, 5000);
            }
        }

        function deleteMemo(id) {
            memos = memos.filter(m => m.id !== id);
            localStorage.setItem('memos', JSON.stringify(memos));
            openMemoSection();
        }

        // ä¹¦ç±ç®¡ç†
        function addBook() {
            let book = document.getElementById('bookInput').value.trim();
            if(book) {
                bookList.push(book);
                localStorage.setItem('bookList', JSON.stringify(bookList));
                renderBookList();
                document.getElementById('bookInput').value = '';
            }
        }

        function bulkAddBooks() {
            let text = document.getElementById('bulkBookInput').value.trim();
            if(text) {
                let books = text.split('\n').filter(b => b.trim() !== '');
                bookList.push(...books);
                localStorage.setItem('bookList', JSON.stringify(bookList));
                renderBookList();
                document.getElementById('bulkBookInput').value = '';
            }
        }

        function renderBookList() {
            let list = document.getElementById('bookList');
            if(!list) return;
            list.innerHTML = '';
            bookList.forEach((book, idx) => {
                let div = document.createElement('div');
                div.className = 'book-item';
                div.innerHTML = `<span>${book}</span><button class="send-btn" onclick="removeBook(${idx})">åˆ é™¤</button>`;
                list.appendChild(div);
            });
        }

        function removeBook(idx) {
            bookList.splice(idx, 1);
            localStorage.setItem('bookList', JSON.stringify(bookList));
            renderBookList();
        }

        function recommendBook() {
            if(bookList.length) {
                let book = bookList[Math.floor(Math.random() * bookList.length)];
                document.getElementById('bookResult').innerText = 'æ¨è: ' + book;
            }
        }

        // ä»Šæ—¥å¯ä»¥åš
        function addTodo() {
            let todo = document.getElementById('todoInput').value.trim();
            if(todo) {
                todoList.push(todo);
                localStorage.setItem('todoList', JSON.stringify(todoList));
                renderTodoList();
                document.getElementById('todoInput').value = '';
            }
        }

        function renderTodoList() {
            let list = document.getElementById('todoList');
            if(!list) return;
            list.innerHTML = '';
            todoList.forEach((todo, idx) => {
                let div = document.createElement('div');
                div.className = 'todo-item';
                div.innerHTML = `<span>${todo}</span><button class="send-btn" onclick="removeTodo(${idx})">åˆ é™¤</button>`;
                list.appendChild(div);
            });
        }

        function removeTodo(idx) {
            todoList.splice(idx, 1);
            localStorage.setItem('todoList', JSON.stringify(todoList));
            renderTodoList();
        }

        function pickRandomTodo() {
            if(todoList.length) {
                let todo = todoList[Math.floor(Math.random() * todoList.length)];
                document.getElementById('todoResult').innerText = 'ä»Šå¤©å¯ä»¥åš: ' + todo;
            }
        }

        // å–«èŒ¶åˆ¸å›å¤ç®¡ç†
        function addCouponReply() {
            let reply = document.getElementById('couponReplyInput').value.trim();
            if(reply) {
                couponReplies.push(reply);
                localStorage.setItem('couponReplies', JSON.stringify(couponReplies));
                renderCouponReplyList();
                document.getElementById('couponReplyInput').value = '';
            }
        }

        function renderCouponReplyList() {
            let list = document.getElementById('couponReplyList');
            if(!list) return;
            list.innerHTML = '';
            couponReplies.forEach((reply, idx) => {
                let div = document.createElement('div');
                div.className = 'flex-row';
                div.innerHTML = `<span>${reply}</span><button class="send-btn" onclick="removeCouponReply(${idx})">åˆ é™¤</button>`;
                list.appendChild(div);
            });
        }

        function removeCouponReply(idx) {
            couponReplies.splice(idx, 1);
            localStorage.setItem('couponReplies', JSON.stringify(couponReplies));
            renderCouponReplyList();
        }

        // æ­Œæ›²ä¼ è®¯è‡ªå®šä¹‰
        function customSongMessage() {
            let playlistCount = parseInt(document.getElementById('customPlaylistCount').value) || Math.floor(Math.random() * 2000) + 1;
            let songCount = parseInt(document.getElementById('customSongCount').value) || Math.floor(Math.random() * 10000) + 1;
            
            if(playlistCount > 2000) playlistCount = 2000;
            if(songCount > 10000) songCount = 10000;
            
            let randomPlaylist = Math.floor(Math.random() * playlistCount) + 1;
            let randomSong = Math.floor(Math.random() * songCount) + 1;
            document.getElementById('songMessage').innerText = `ç¬¬${randomPlaylist}ä¸ªæ­Œå•ä¸­çš„ç¬¬${randomSong}é¦–æ­Œ`;
        }

        // å›¾ç‰‡å‘é€
        function openImageModal() { document.getElementById('imageModal').classList.add('show'); showImageTab('upload'); }
        function closeImageModal() { document.getElementById('imageModal').classList.remove('show'); currentImageData = null; document.getElementById('imagePreview').innerHTML = ''; }
        function showImageTab(tab) {
            document.getElementById('imageUploadTab').style.display = tab==='upload'?'block':'none';
            document.getElementById('imageUrlTab').style.display = tab==='url'?'block':'none';
        }
        function previewImage(event) {
            let file = event.target.files[0];
            if(file) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').innerHTML = `<img src="${e.target.result}" style="max-width:100%; max-height:150px; border-radius:15px;">`;
                    currentImageData = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        function sendImage() {
            let activeTab = document.getElementById('imageUploadTab').style.display !== 'none' ? 'upload' : 'url';
            if(activeTab === 'upload' && currentImageData) {
                addImageMessage('me', currentImageData, true);
            } else if(activeTab === 'url') {
                let url = document.getElementById('imageUrl').value.trim();
                if(url) addImageMessage('me', url, true);
            }
            closeImageModal();
            simulateOtherReply();
        }

        // æ‰¹é‡å‘é€
        function openBulkModal() { document.getElementById('bulkModal').classList.add('show'); bulkMessages = []; renderBulkList(); }
        function closeBulkModal() { document.getElementById('bulkModal').classList.remove('show'); }
        function prepareBulkMessages() {
            let text = document.getElementById('bulkInput').value;
            let lines = text.split('\n').filter(l => l.trim() !== '');
            bulkMessages = lines.map((msg, idx) => ({ id: 'b'+Date.now()+idx, text: msg }));
            renderBulkList();
        }
        function renderBulkList() {
            let container = document.getElementById('bulkMessageList');
            container.innerHTML = '';
            bulkMessages.forEach((msg, index) => {
                let div = document.createElement('div');
                div.className = 'bulk-message-item';
                div.innerHTML = `<span>${msg.text}</span><button class="send-btn" style="padding:2px 10px;" onclick="removeBulkMessage(${index})">âœ•</button>`;
                container.appendChild(div);
            });
        }
        function removeBulkMessage(idx) { bulkMessages.splice(idx, 1); renderBulkList(); }
        function sendAllBulkMessages() {
            bulkMessages.forEach(m => addMessage('me', m.text, true));
            closeBulkModal();
            simulateOtherReply();
        }

        // ä¸€èµ·å¬æ­Œ
        function addMusicLink() {
            let url = document.getElementById('musicLinkInput').value.trim();
            if(!url) return;
            musicPlaylist.push({ url, title: 'éŸ³ä¹' + (musicPlaylist.length+1) });
            document.getElementById('musicLinkInput').value = '';
            renderMusicPlaylist();
            saveMusicPlaylist();
        }
        function renderMusicPlaylist() {
            let container = document.getElementById('musicPlaylist');
            if(!container) return;
            container.innerHTML = '';
            musicPlaylist.forEach((item, idx) => {
                let div = document.createElement('div');
                div.className = 'music-item';
                div.innerHTML = `
                    <input type="text" value="${item.title}" onchange="updateMusicTitle(${idx}, this.value)">
                    <button class="send-btn" style="padding:2px 10px;" onclick="playMusic(${idx})">â–¶ï¸</button>
                    <button class="send-btn" style="padding:2px 10px;" onclick="removeMusic(${idx})">âœ•</button>
                `;
                container.appendChild(div);
            });
        }
        function updateMusicTitle(index, newTitle) {
            musicPlaylist[index].title = newTitle;
            saveMusicPlaylist();
        }
        function playMusic(index) {
            if(musicPlaylist[index]) {
                currentMusicIndex = index;
                let url = musicPlaylist[index].url;
                let embedHtml = '';
                if(url.includes('youtube.com') || url.includes('youtu.be')) {
                    let videoId = url.split('v=')[1] || url.split('/').pop();
                    if(videoId.includes('&')) videoId = videoId.split('&')[0];
                    embedHtml = `<iframe width="100%" height="80" src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                } else if(url.includes('music.163.com')) {
                    let id = url.split('id=')[1] || '';
                    embedHtml = `<iframe frameborder="0" style="width:100%;height:80px;" src="https://music.163.com/outchain/player?type=2&id=${id}&auto=1&height=66"></iframe>`;
                } else if(url.includes('qq.com')) {
                    embedHtml = `<iframe frameborder="0" style="width:100%;height:80px;" src="https://i.y.qq.com/n2/m/outchain/player.html?songid=${url.split('/').pop()}&auto=1"></iframe>`;
                } else embedHtml = `<p>æ— æ³•åµŒå…¥ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€é“¾æ¥: <a href="${url}" target="_blank">æ’­æ”¾</a></p>`;
                document.getElementById('musicEmbedArea').innerHTML = embedHtml;
            }
        }
        function removeMusic(idx) { musicPlaylist.splice(idx,1); renderMusicPlaylist(); saveMusicPlaylist(); }
        function playNextMusic() { if(musicPlaylist.length>0) playMusic((currentMusicIndex+1)%musicPlaylist.length); }
        function playPreviousMusic() { if(musicPlaylist.length>0) playMusic((currentMusicIndex-1+musicPlaylist.length)%musicPlaylist.length); }
        function repeatCurrentMusic() { if(currentMusicIndex>=0) playMusic(currentMusicIndex); }
        function toggleMusicPlay() { alert('å†…åµŒæ’­æ”¾å™¨å·²è‡ªå¸¦æ§åˆ¶'); }
        function saveMusicPlaylist() { localStorage.setItem('musicPlaylist', JSON.stringify(musicPlaylist)); }

        // å†³ç­–å¸
        function flipDecisionCoin() {
            let question = document.getElementById('decisionQuestion').value.trim();
            let result = Math.random() > 0.5 ? 'YES' : 'NO';
            document.getElementById('decisionResult').innerText = result;
            if(question) {
                addMessage('me', 'â“ ' + question + ' â†’ ' + result, true);
            }
        }

        // æ¯æ—¥è¿åŠ¿
        const fortunes = ['å¤§å‰', 'ä¸­å‰', 'å°å‰', 'å‰', 'æœ«å‰', 'å‡¶', 'å¤§å‡¶'];
        function drawFortune() { document.getElementById('dailyFortune').innerText = fortunes[Math.floor(Math.random() * fortunes.length)]; }

        // å¼€å…³åŠŸèƒ½
        function toggleSetting(name) {
            settings[name] = !settings[name];
            updateToggleButton(name);
            localStorage.setItem('settings', JSON.stringify(settings));
        }
        function updateToggleButton(name) {
            let btn = document.getElementById(name+'Toggle');
            if(btn) btn.innerText = settings[name] ? 'å¼€å¯' : 'å…³é—­';
        }
        function updateAllToggleButtons() {
            for(let key in settings) updateToggleButton(key);
        }

        // å¤–è§‚åŠŸèƒ½
        function changeBgColor(color) { document.body.style.backgroundColor = color; }
        function changeBubbleColor(color) { document.documentElement.style.setProperty('--message-me', color); }
        function changeBubbleShape(radius) {
            document.documentElement.style.setProperty('--bubble-radius', radius);
        }
        function applyBubbleCustomCSS() {
            let css = document.getElementById('bubbleCustomCSS').value;
            if(css) {
                let style = document.createElement('style');
                style.innerText = css;
                document.head.appendChild(style);
            }
        }
        function applyFontLink(url) {
            if(url) {
                let link = document.createElement('link');
                link.href = url;
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
        }
        function adjustFontSize(size) {
            document.documentElement.style.setProperty('--font-size-base', size + 'px');
            document.getElementById('fontSizeDisplay').innerText = size + 'px';
        }
        function toggleAvatarVisibility() {
            avatarVisible = !avatarVisible;
            document.querySelectorAll('.avatar-img, .avatar-name').forEach(el => el.style.display = avatarVisible ? 'flex' : 'none');
            document.getElementById('avatarToggleBtn').innerText = avatarVisible ? 'å¼€å¯' : 'å…³é—­';
        }
        function adjustAvatarSize(val) { 
            avatarSize = val; 
            document.querySelectorAll('.avatar-img').forEach(img => { 
                img.style.width = val + 'px'; 
                img.style.height = val + 'px'; 
            }); 
        }
        function uploadBackgroundImage() {
            let input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
            input.onchange = e => { let file = e.target.files[0]; if(file) { let reader = new FileReader(); reader.onload = ev => { document.querySelector('.chat-main').style.backgroundImage = `url(${ev.target.result})`; document.querySelector('.chat-main').style.backgroundSize = 'cover'; }; reader.readAsDataURL(file); } };
            input.click();
        }
        function updateNames() { 
            document.getElementById('meName').innerText = document.getElementById('meNameInput').value; 
            document.getElementById('otherName').innerText = document.getElementById('otherNameInput').value; 
            updateLoveDays();
        }

        // çºªå¿µæ—¥ç®¡ç†
        function addAnniversary() {
            let name = document.getElementById('anniversaryName').value.trim();
            let date = document.getElementById('anniversaryDate').value;
            if(!name || !date) return;
            
            let annDate = new Date(date);
            anniversaries.push({ 
                name, 
                date: date,
                originalDate: date,
                type: 'anniversary'
            });
            localStorage.setItem('anniversaries', JSON.stringify(anniversaries));
            renderAnniversaries();
            document.getElementById('anniversaryName').value = '';
            document.getElementById('anniversaryDate').value = '';
        }

        function renderAnniversaries() {
            let container = document.getElementById('anniversaryList');
            if(!container) return;
            container.innerHTML = '';
            let today = new Date();
            today.setHours(0,0,0,0);
            
            anniversaries.forEach((item, idx) => {
                let annDate = new Date(item.originalDate);
                let currentYear = today.getFullYear();
                annDate.setFullYear(currentYear);
                
                if(annDate < today) {
                    annDate.setFullYear(currentYear + 1);
                }
                
                let diffDays = Math.ceil((annDate - today) / (1000*60*60*24));
                let status = diffDays === 0 ? 'å°±æ˜¯ä»Šå¤©ï¼' : `è¿˜æœ‰ ${diffDays} å¤©`;
                
                if(diffDays <= 7 && diffDays > 0) {
                    status += ' âš ï¸ å³å°†åˆ°æ¥';
                }
                
                let div = document.createElement('div');
                div.className = 'anniversary-item';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <span>${item.name}</span>
                        <button onclick="removeAnniversary(${idx})">âœ•</button>
                    </div>
                    <div>${item.originalDate} (${status})</div>
                `;
                container.appendChild(div);
            });
        }

        function removeAnniversary(idx) {
            anniversaries.splice(idx, 1);
            localStorage.setItem('anniversaries', JSON.stringify(anniversaries));
            renderAnniversaries();
        }

        // é£Ÿç‰©
        function addFood() {
            let food = document.getElementById('foodInput').value.trim();
            if(food) { foodItems.push(food); document.getElementById('foodInput').value = ''; renderFoodList(); saveFood(); }
        }
        function renderFoodList() {
            let container = document.getElementById('foodList');
            if(!container) return;
            container.innerHTML = '';
            foodItems.forEach((f, idx) => {
                let span = document.createElement('span'); span.style.background = 'var(--message-me)'; span.style.padding = '4px 8px'; span.style.borderRadius = '20px'; span.style.margin = '2px'; span.innerText = f;
                span.onclick = () => { foodItems.splice(idx,1); renderFoodList(); saveFood(); };
                container.appendChild(span);
            });
        }
        function pickRandomFood() {
            if(foodItems.length) document.getElementById('foodResult').innerText = 'ä»Šå¤©åƒ: ' + foodItems[Math.floor(Math.random() * foodItems.length)];
            else document.getElementById('foodResult').innerText = 'è¯·å…ˆæ·»åŠ é£Ÿç‰©';
        }
        function saveFood() { localStorage.setItem('foodItems', JSON.stringify(foodItems)); }

        // æ•°æ®å¯¼å…¥å¯¼å‡º
        function exportAllData() {
            let data = {
                sessions, groups, chatMessages, cardCategories, cardRatios, customEmojis,
                foodItems, memos, periodData, anniversaries, bookList, todoList,
                musicPlaylist, patReplies, otherStatusList, favoriteReplies,
                couponReplies, bookReviews, messageStats, loveStartDate, couponMessages,
                settings
            };
            let blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = 'bearrabbit_data.json';
            a.click();
        }
        function importAllData() {
            document.getElementById('importFile').click();
        }
        function handleImportFile(event) {
            let file = event.target.files[0];
            if(!file) return;
            let reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data = JSON.parse(e.target.result);
                    if(data.sessions) sessions = data.sessions;
                    if(data.groups) groups = data.groups;
                    if(data.chatMessages) chatMessages = data.chatMessages;
                    if(data.cardCategories) cardCategories = data.cardCategories;
                    if(data.cardRatios) cardRatios = data.cardRatios;
                    if(data.customEmojis) customEmojis = data.customEmojis;
                    if(data.foodItems) foodItems = data.foodItems;
                    if(data.memos) memos = data.memos;
                    if(data.periodData) periodData = data.periodData;
                    if(data.anniversaries) anniversaries = data.anniversaries;
                    if(data.bookList) bookList = data.bookList;
                    if(data.todoList) todoList = data.todoList;
                    if(data.musicPlaylist) musicPlaylist = data.musicPlaylist;
                    if(data.patReplies) patReplies = data.patReplies;
                    if(data.otherStatusList) otherStatusList = data.otherStatusList;
                    if(data.favoriteReplies) favoriteReplies = data.favoriteReplies;
                    if(data.couponReplies) couponReplies = data.couponReplies;
                    if(data.bookReviews) bookReviews = data.bookReviews;
                    if(data.messageStats) messageStats = data.messageStats;
                    if(data.loveStartDate) loveStartDate = data.loveStartDate;
                    if(data.couponMessages) couponMessages = data.couponMessages;
                    if(data.settings) settings = data.settings;
                    
                    saveAllSettings();
                    alert('å¯¼å…¥æˆåŠŸï¼');
                    location.reload();
                } catch(err) {
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
                }
            };
            reader.readAsText(file);
        }

        function saveAppearanceSettings() { alert('å¤–è§‚å·²ä¿å­˜'); }
        function saveChatSettings() { alert('èŠå¤©è®¾ç½®å·²ä¿å­˜'); }
        function saveAllDailySettings() { alert('æ—¥å¸¸è®¾ç½®å·²ä¿å­˜'); }
        function saveAllSettings() {
            localStorage.setItem('sessions', JSON.stringify(sessions));
            localStorage.setItem('groups', JSON.stringify(groups));
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
            localStorage.setItem('cardCategories', JSON.stringify(cardCategories));
            localStorage.setItem('cardRatios', JSON.stringify(cardRatios));
            localStorage.setItem('customEmojis', JSON.stringify(customEmojis));
            localStorage.setItem('foodItems', JSON.stringify(foodItems));
            localStorage.setItem('memos', JSON.stringify(memos));
            localStorage.setItem('periodData', JSON.stringify(periodData));
            localStorage.setItem('anniversaries', JSON.stringify(anniversaries));
            localStorage.setItem('bookList', JSON.stringify(bookList));
            localStorage.setItem('todoList', JSON.stringify(todoList));
            localStorage.setItem('musicPlaylist', JSON.stringify(musicPlaylist));
            localStorage.setItem('patReplies', JSON.stringify(patReplies));
            localStorage.setItem('otherStatusList', JSON.stringify(otherStatusList));
            localStorage.setItem('favoriteReplies', JSON.stringify(favoriteReplies));
            localStorage.setItem('couponReplies', JSON.stringify(couponReplies));
            localStorage.setItem('bookReviews', JSON.stringify(bookReviews));
            localStorage.setItem('messageStats', JSON.stringify(messageStats));
            localStorage.setItem('loveStartDate', loveStartDate);
            localStorage.setItem('couponMessages', JSON.stringify(couponMessages));
            localStorage.setItem('settings', JSON.stringify(settings));
            alert('å…¨éƒ¨è®¾ç½®å·²ä¿å­˜åˆ°æœ¬åœ°');
        }
        function loadFromStorage() {
            if(localStorage.getItem('sessions')) sessions = JSON.parse(localStorage.getItem('sessions'));
            if(localStorage.getItem('groups')) groups = JSON.parse(localStorage.getItem('groups'));
            if(localStorage.getItem('chatMessages')) chatMessages = JSON.parse(localStorage.getItem('chatMessages'));
            if(localStorage.getItem('cardCategories')) cardCategories = JSON.parse(localStorage.getItem('cardCategories'));
            if(localStorage.getItem('cardRatios')) cardRatios = JSON.parse(localStorage.getItem('cardRatios'));
            if(localStorage.getItem('customEmojis')) customEmojis = JSON.parse(localStorage.getItem('customEmojis'));
            if(localStorage.getItem('foodItems')) foodItems = JSON.parse(localStorage.getItem('foodItems'));
            if(localStorage.getItem('memos')) memos = JSON.parse(localStorage.getItem('memos'));
            if(localStorage.getItem('periodData')) periodData = JSON.parse(localStorage.getItem('periodData'));
            if(localStorage.getItem('anniversaries')) anniversaries = JSON.parse(localStorage.getItem('anniversaries'));
            if(localStorage.getItem('bookList')) bookList = JSON.parse(localStorage.getItem('bookList'));
            if(localStorage.getItem('todoList')) todoList = JSON.parse(localStorage.getItem('todoList'));
            if(localStorage.getItem('musicPlaylist')) musicPlaylist = JSON.parse(localStorage.getItem('musicPlaylist'));
            if(localStorage.getItem('patReplies')) patReplies = JSON.parse(localStorage.getItem('patReplies'));
            if(localStorage.getItem('otherStatusList')) otherStatusList = JSON.parse(localStorage.getItem('otherStatusList'));
            if(localStorage.getItem('favoriteReplies')) favoriteReplies = JSON.parse(localStorage.getItem('favoriteReplies'));
            if(localStorage.getItem('couponReplies')) couponReplies = JSON.parse(localStorage.getItem('couponReplies'));
            if(localStorage.getItem('bookReviews')) bookReviews = JSON.parse(localStorage.getItem('bookReviews'));
            if(localStorage.getItem('messageStats')) messageStats = JSON.parse(localStorage.getItem('messageStats'));
            if(localStorage.getItem('loveStartDate')) loveStartDate = localStorage.getItem('loveStartDate');
            if(localStorage.getItem('couponMessages')) couponMessages = JSON.parse(localStorage.getItem('couponMessages'));
            if(localStorage.getItem('settings')) settings = JSON.parse(localStorage.getItem('settings'));
        }
        function clearAllData() { if(confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®?')) { localStorage.clear(); location.reload(); } }
        function resetToDefault() { localStorage.clear(); location.reload(); }
        function handleKeyPress(e) { if(e.key==='Enter') sendMessage(); }
        function uploadAvatar(event, who) {
            let file = event.target.files[0];
            if(file) { let reader = new FileReader(); reader.onload = e => document.getElementById(who+'AvatarImg').src = e.target.result; reader.readAsDataURL(file); }
        }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); document.getElementById('themeToggle').innerText = document.body.classList.contains('dark-mode')?'ğŸŒ™':'â˜€ï¸'; }
        function openDrawer(section) {
            document.getElementById('drawer').classList.add('open'); document.getElementById('overlay').classList.add('show');
            document.querySelectorAll('.drawer-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + 'Section').classList.remove('hidden');
            if(section==='daily') { 
                renderMusicPlaylist(); 
                renderFoodList(); 
                renderAnniversaries();
                renderBookList();
                renderTodoList();
                renderCouponReplyList();
                updateMessageStats();
            }
            if(section==='chat') { 
                renderSessionList(); 
                renderGroupList();
                renderPatReplyList();
                renderStatusList();
                renderFavoritesList();
            }
        }
        function closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('overlay').classList.remove('show'); }
        function triggerHeWantsToSay() { 
            let allCards = getAllCards();
            let reply = '';
            for(let i=0; i<3; i++) {
                reply += allCards[Math.floor(Math.random() * allCards.length)] + ' ';
            }
            addMessage('other', reply, false); 
        }
    </script>
</body>
</html>
```
